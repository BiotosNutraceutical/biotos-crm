<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no, email=no, address=no">
  <title>Biotos CRM – v8.0</title>
  <meta name="theme-color" content="#12a06a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Biotos CRM">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#07130e; --panel:#0c2319; --panel2:#0a1c15; --muted:#bfe6d5; --text:#f7fff9; --accent:#12a06a; --line:#1a563b;
      --error:#ff6a6a; --warn:#ffb84d; --ok:#28d07e;
    }
    [data-theme="light"]{
      --bg:#f6fffa; --panel:#ffffff; --panel2:#f4fbf8; --muted:#315a49; --text:#0c2019; --accent:#12a06a; --line:#cfe7dc;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16.5px/1.52 -apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:#a6ffd8;text-decoration:none}
    header{position:sticky;top:0;background:var(--bg);z-index:30;padding-top:calc(6px + env(safe-area-inset-top));border-bottom:1px solid rgba(23,86,59,.35);backdrop-filter:saturate(1.2) blur(4px)}
    .wrap{max-width:1100px;margin:0 auto;padding:10px 12px}
    h1{font-size:18px;margin:0 0 4px;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
    h1 img{width:26px;height:26px;border-radius:6px;border:1px solid var(--line);background:#fff}
    .savebadge{margin-left:auto;font-size:12px;color:#bfe5cf}
    .theme{margin-left:8px}
    .theme select{background:var(--panel2);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px}
    .bottomnav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--line);
      display:flex;gap:6px;padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);z-index:25}
    .bottomnav button{flex:1;border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:12px;border-radius:12px;min-height:44px;font-size:15px}
    .bottomnav button.active{border-color:var(--accent);background:#0f2e22;box-shadow:inset 0 0 0 1px #13a26322}
    .topnav{display:none;gap:8px;margin-top:8px}
    .topnav button{border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:10px 12px;border-radius:12px;min-height:40px;font-size:15px}
    .topnav button.active{border-color:var(--accent);background:#0f2e22;box-shadow:inset 0 0 0 1px #13a26322}
    .grid{display:grid;gap:12px;contain:paint}
    .pan{background:var(--panel);padding:12px;border-radius:14px;border:1px solid var(--line)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1 1 280px}
    label{display:block;font-size:12px;color:#cde3d9;margin-bottom:6px}
    input,select,textarea{width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--line);border-radius:12px;padding:12px;min-height:44px;font-size:16px}
    input:invalid,select:invalid,textarea:invalid{border-color:var(--error); box-shadow:0 0 0 1px #ff8a8a22 inset}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#103024;color:var(--text);padding:12px 14px;border-radius:12px;cursor:pointer;min-height:44px;font-size:16px;-webkit-tap-highlight-color:transparent}
    .btn.primary{border-color:var(--accent);background:#0f2e22;box-shadow:inset 0 0 0 1px #13a26322}
    .btn.block{width:100%;justify-content:center}
    .btn.ghost{background:transparent}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0b2b1e;color:#cfe}
    .muted{color:var(--muted)} .right{margin-left:auto} .hidden{display:none!important}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .kpis .pan{padding:10px} .kpis h3{margin:6px 0 4px;font-size:12px;color:#cfe8dc} .kpis .value{font-size:22px;font-weight:700}
    .tablewrap{max-height:60vh;overflow:auto;border:1px solid var(--line);border-radius:12px;-webkit-overflow-scrolling:touch}
    .cards{display:grid;gap:10px;contain:paint}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;gap:10px;align-items:flex-start}
    .card .main{flex:1;min-width:0}
    .card .title{font-weight:800; letter-spacing:.2px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .card .subtitle{color:#d6eee4; font-size:13px;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .card .meta{font-size:13px;color:#b7c7bf;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .actions{display:flex;gap:8px;margin-top:10px}
    .chip{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);margin-left:6px;background:#0b2b1e;color:#d9ffe9}
    .fab{position:fixed;right:16px;bottom:calc(110px + env(safe-area-inset-bottom));width:56px;height:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;background:var(--accent);color:#07170f;font-weight:800;border:0;z-index:24;box-shadow:0 8px 24px rgba(0,0,0,.42)}
    .sheet{position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);z-index:40}
    .sheet.open{display:block}
    .sheet .panel{position:absolute;left:0;right:0;bottom:0;background:#0c2219;border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      padding:14px 12px calc(16px + env(safe-area-inset-bottom));max-height:90vh;overflow:auto}
    .sheet h3{margin:4px 4px 10px}
    .sheet .row>*{flex:1 1 240px}
    .sheet .close{position:absolute;right:10px;top:8px;background:transparent;border:0;color:#dfe; font-size:24px}
    details{background:#0b241a;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    details>summary{cursor:pointer;font-weight:700}
    details[open]{box-shadow:inset 0 0 0 1px #13a26322}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(70px + env(safe-area-inset-bottom));background:#0f2e22;border:1px solid var(--line);padding:10px 14px;border-radius:12px;z-index:50;display:none}
    .toast.show{display:block}
    .update{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(120px + env(safe-area-inset-bottom));background:#1a2f27;border:1px solid var(--line);padding:10px 14px;border-radius:12px;z-index:50;display:none}
    .update.show{display:flex;gap:8px;align-items:center}
    .quickchips{display:flex;gap:6px;flex-wrap:wrap}
    .quickchips button{border:1px dashed var(--line);background:transparent;color:#cfe;padding:6px 10px;border-radius:10px}
    .stat{font-variant-numeric:tabular-nums}
    @media (min-width:900px){
      .bottomnav{display:none}
      .topnav{display:flex}
      .wrap{padding-bottom:24px}
      .cards{display:none}
      .tablewrap{display:block}
      .fab{display:none}
    }
    @media (max-width:899px){
      .wrap{padding-bottom:120px}
      .tablewrap{display:none}
      .cards{display:grid}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><img src="icons/icon-192.png" alt="logo"> Biotos CRM <span class="muted">v8.0</span>
      <span class="savebadge" id="savebadge">Salvato ✓</span>
      <span class="theme"><select id="themeSel"><option value="auto">Tema: Auto</option><option value="dark">Scuro</option><option value="light">Chiaro</option></select></span>
    </h1>
    <div class="topnav">
      <button class="tabbtn active" data-tab="dashboard">Dashboard</button>
      <button class="tabbtn" data-tab="medici">Medici</button>
      <button class="tabbtn" data-tab="farmacie">Farmacie</button>
      <button class="tabbtn" data-tab="visite">Visite</button>
      <button class="tabbtn" data-tab="followup">Follow-up</button>
      <button class="tabbtn" data-tab="io">Dati</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="dashboard" class="grid">
    <div class="kpis">
      <div class="pan"><h3>Medici schedati</h3><div class="value stat" id="k_medici">0</div></div>
      <div class="pan"><h3>Farmacie schedate</h3><div class="value stat" id="k_farmacie">0</div></div>
      <div class="pan"><h3>Visite totali</h3><div class="value stat" id="k_visite">0</div></div>
      <div class="pan"><h3>Follow-up scaduti</h3><div class="value stat" id="k_fu_over">0</div></div>
      <div class="pan"><h3>Follow-up prossimi 3 gg</h3><div class="value stat" id="k_fu_soon">0</div></div>
      <div class="pan"><h3>Ordini stimati FV / FL</h3><div class="value stat"><span id="k_ord_fv">0</span> / <span id="k_ord_fl">0</span></div></div>
    </div>
    <div class="pan">
      <h3 style="margin:0 0 8px">Follow-up imminenti</h3>
      <div class="tablewrap"><table id="tbl_fu"><thead><tr>
        <th>Data</th><th>Tipo</th><th>Rif.</th><th>Prossimo step</th><th>Contatto</th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_fu"></div>
    </div>
  </section>

  <section id="medici" class="grid hidden">
    <div class="pan">
      <details>
        <summary>Ricerca avanzata</summary>
        <div class="row">
          <div><label>Nome/Cognome</label><input id="m_q" placeholder="es. Rossi Mario"></div>
          <div><label>Comune</label><input id="m_q_comune" placeholder="es. Cosenza"></div>
          <div><label>Specialità</label><select id="m_q_spec"><option value="">Tutte</option><option>Ginecologia</option><option>MMG</option><option>Altro</option></select></div>
          <div class="right"><label>&nbsp;</label><button class="btn ghost" id="m_btn_sort">Ordina A→Z</button></div>
        </div>
      </details>
      <div class="row">
        <div class="right">
          <button class="btn" id="btn_exp_med">⬇️ Export CSV</button>
        </div>
      </div>
      <div class="tablewrap"><table id="tbl_medici"><thead><tr>
        <th>Nome</th><th>Specialità</th><th>Studio</th><th>Comune</th><th>Contatti</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_medici"></div>
      <div class="right muted" id="info_medici"></div>
      <button class="fab" id="fab_medico" title="Nuovo medico">＋</button>
    </div>
  </section>

  <section id="farmacie" class="grid hidden">
    <div class="pan">
      <details>
        <summary>Ricerca avanzata</summary>
        <div class="row">
          <div><label>Ragione Sociale</label><input id="f_q" placeholder="es. Farmacia Centrale"></div>
          <div><label>Comune</label><input id="f_q_comune" placeholder="es. Rende"></div>
          <div class="right"><label>&nbsp;</label><button class="btn ghost" id="f_btn_sort">Ordina A→Z</button></div>
        </div>
      </details>
      <div class="row">
        <div class="right">
          <button class="btn" id="btn_exp_far">⬇️ Export CSV</button>
        </div>
      </div>
      <div class="tablewrap"><table id="tbl_farmacie"><thead><tr>
        <th>Ragione Sociale</th><th>Comune</th><th>Indirizzo</th><th>Contatti</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_farmacie"></div>
      <div class="right muted" id="info_farmacie"></div>
      <button class="fab" id="fab_farmacia" title="Nuova farmacia">＋</button>
    </div>
  </section>

  <section id="visite" class="grid hidden">
    <div class="pan">
      <details>
        <summary>Ricerca avanzata</summary>
        <div class="row">
          <div><label>Dal</label><input type="date" id="v_q_from"></div>
          <div><label>Al</label><input type="date" id="v_q_to"></div>
          <div><label>Tipo</label><select id="v_q_tipo"><option value="">Tutti</option><option>Medico</option><option>Farmacia</option></select></div>
          <div><label>Esito</label><select id="v_q_esito"><option value="">Tutti</option><option>Incontro svolto</option><option>Rifiutato</option><option>Assente</option><option>Solo materiale</option><option>Nuovo contatto</option></select></div>
          <div><label>Prodotti</label><select id="v_q_prod"><option value="">Tutti</option><option>FV</option><option>FL</option><option>Entrambi</option><option>—</option></select></div>
          <div class="right"><label>&nbsp;</label><button class="btn ghost" id="v_btn_sort">Ordina recenti</button></div>
        </div>
      </details>
      <div class="row">
        <div class="right"><button class="btn" id="btn_exp_vis">⬇️ Export CSV</button></div>
      </div>
      <div class="tablewrap"><table id="tbl_visite"><thead><tr>
        <th>Data</th><th>Tipo</th><th>Rif.</th><th>Prodotti</th><th>Esito</th><th>Next</th><th>Follow-up</th><th>Ref.</th><th>Ord FV/FL</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_visite"></div>
      <div class="right muted" id="info_visite"></div>
      <button class="fab" id="fab_visita" title="Nuova visita">＋</button>
    </div>
  </section>

  <section id="followup" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Filtra per stato</label>
          <select id="fu_state">
            <option value="all">Tutti</option>
            <option value="over">Scaduti</option>
            <option value="soon">Prossimi 3 gg</option>
            <option value="future">Oltre 3 gg</option>
          </select>
        </div>
        <div class="right"><label>&nbsp;</label><button class="btn" id="btn_exp_ics">📅 Esporta iCal</button></div>
      </div>
      <div class="tablewrap"><table id="tbl_follow"><thead><tr>
        <th>Data</th><th>Tipo</th><th>Rif.</th><th>Prossimo step</th><th>Contatto</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_follow"></div>
    </div>
  </section>

  <section id="io" class="grid hidden">
    <div class="pan">
      <h3 style="margin:0 0 8px">Backup & Dati</h3>
      <div class="row">
        <button class="btn" id="btn_exp_json">⬇️ Esporta backup JSON</button>
        <input type="file" id="inp_imp_json" accept="application/json" class="btn">
        <button class="btn" id="btn_clear" title="Cancella tutti i dati (usa con cautela)">🗑️ Reset dati</button>
      </div>
      <p class="muted">I dati restano sul dispositivo (IndexedDB + LocalStorage). Uso attuale: <span id="stor_usage">–</span></p>
    </div>
    <div class="pan">
      <h3 style="margin:0 8px 8px">Sync “soft” via GitHub (opzionale)</h3>
      <div class="row">
        <div><label>Owner</label><input id="gh_owner" placeholder="es. biotos"></div>
        <div><label>Repo</label><input id="gh_repo" placeholder="es. crm-sync"></div>
        <div><label>Branch</label><input id="gh_branch" value="main"></div>
        <div><label>Path JSON</label><input id="gh_path" value="biotos_crm_data.json"></div>
        <div><label>Token (scopo: repo)</label><input id="gh_token" type="password" placeholder="ghp_xxx"></div>
      </div>
      <div class="row">
        <button class="btn" id="btn_pull">⬇️ Pull</button>
        <button class="btn" id="btn_push">⬆️ Push</button>
      </div>
      <p class="help muted">Il token resta salvato <b>in locale</b>. Usa un repo privato.</p>
    </div>
  </section>
</main>

<nav class="bottomnav">
  <button class="tabbtn active" data-tab="dashboard">Dashboard</button>
  <button class="tabbtn" data-tab="medici">Medici</button>
  <button class="tabbtn" data-tab="farmacie">Farmacie</button>
  <button class="tabbtn" data-tab="visite">Visite</button>
  <button class="tabbtn" data-tab="followup">Follow-up</button>
  <button class="tabbtn" data-tab="io">Dati</button>
</nav>

<div class="sheet" id="sheet_medico">
  <div class="panel">
    <button class="close" data-close="sheet_medico">✕</button>
    <h3 id="sheet_medico_title">Nuovo medico</h3>
    <div class="row">
      <div><label>Titolo</label><input id="m_titolo"></div>
      <div><label>Nome *</label><input id="m_nome" required></div>
      <div><label>Cognome *</label><input id="m_cognome" required></div>
      <div><label>Specialità</label>
        <select id="m_spec"><option>Ginecologia</option><option>MMG</option><option>Altro</option></select>
      </div>
    </div>
    <div class="row">
      <div><label>Studio/Struttura</label><input id="m_struttura"></div>
      <div><label>Comune</label><input id="m_comune"></div>
      <div><label>Indirizzo</label><input id="m_indirizzo"></div>
    </div>
    <div class="row">
      <div><label>Telefono</label><input id="m_tel" type="tel" inputmode="tel" pattern="[0-9+\s()-]{6,}"></div>
      <div><label>Email</label><input id="m_email" type="email" inputmode="email" autocapitalize="none"></div>
    </div>
    <div class="row"><div><label>Note</label><input id="m_note" maxlength="240"></div></div>
    <div class="row"><button class="btn primary block" id="btn_save_medico">Salva</button></div>
  </div>
</div>

<div class="sheet" id="sheet_farmacia">
  <div class="panel">
    <button class="close" data-close="sheet_farmacia">✕</button>
    <h3 id="sheet_farmacia_title">Nuova farmacia</h3>
    <div class="row">
      <div><label>Ragione Sociale *</label><input id="f_ragione" required></div>
      <div><label>Direttore</label><input id="f_direttore"></div>
      <div><label>Comune</label><input id="f_comune"></div>
      <div><label>Indirizzo</label><input id="f_indirizzo"></div>
    </div>
    <div class="row">
      <div><label>Telefono</label><input id="f_tel" type="tel" inputmode="tel" pattern="[0-9+\s()-]{6,}"></div>
      <div><label>Email</label><input id="f_email" type="email" inputmode="email" autocapitalize="none"></div>
      <div><label>Note</label><input id="f_note" maxlength="240"></div>
    </div>
    <div class="row"><button class="btn primary block" id="btn_save_farmacia">Salva</button></div>
  </div>
</div>

<div class="sheet" id="sheet_visita">
  <div class="panel">
    <button class="close" data-close="sheet_visita">✕</button>
    <h3 id="sheet_visita_title">Nuova visita</h3>
    <div class="row">
      <div><label>Data *</label><input type="date" id="v_data" required></div>
      <div><label>Tipo visita *</label><select id="v_tipo" required><option>Medico</option><option>Farmacia</option></select></div>
      <div><label>Riferimento *</label><select id="v_ref" required></select></div>
      <div><label>Referente</label><select id="v_refe"><option>Stefano</option><option>Mariangela</option></select></div>
    </div>
    <div class="row">
      <div><label>Obiettivo visita</label><input id="v_obj" maxlength="140" placeholder="es. presentazione FV, riordino FL..."></div>
      <div><label>Prodotti</label><select id="v_prod"><option>FV</option><option>FL</option><option>Entrambi</option><option>—</option></select></div>
      <div><label>Materiali consegnati</label><input id="v_mat" maxlength="140" placeholder="folder, scheda, locandina..."></div>
    </div>
    <div class="row">
      <div><label>Esito</label><select id="v_esito"><option>Incontro svolto</option><option>Rifiutato</option><option>Assente</option><option>Solo materiale</option><option>Nuovo contatto</option></select></div>
      <div><label>Prossimo step</label><select id="v_next"><option value="">—</option><option>Follow-up telefonico</option><option>Invio materiali</option><option>Richiesta ordine</option><option>Demo/Approfondimento</option><option>Altro</option></select></div>
      <div><label>Data follow-up</label>
        <input type="date" id="v_follow">
        <div class="quickchips">
          <button type="button" data-addd="1">+1g</button>
          <button type="button" data-addd="3">+3g</button>
          <button type="button" data-addd="7">+7g</button>
          <button type="button" data-addd="14">+14g</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div><label>Ordine stimato FV</label><input id="v_fv" type="number" min="0" step="1" value="0" inputmode="numeric"></div>
      <div><label>Ordine stimato FL</label><input id="v_fl" type="number" min="0" step="1" value="0" inputmode="numeric"></div>
      <div><label>Note esito</label><input id="v_note" maxlength="240"></div>
    </div>
    <div class="row"><button class="btn primary block" id="btn_save_visita">Salva</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="update" id="upd"><span>Nuova versione disponibile</span><button class="btn" id="btn_reload">Aggiorna</button></div>

<script>
const themeSel = document.getElementById('themeSel');
const savedTheme = localStorage.getItem('theme') || 'auto';
themeSel.value = savedTheme;
applyTheme(savedTheme);
themeSel.addEventListener('change', ()=>{ localStorage.setItem('theme', themeSel.value); applyTheme(themeSel.value); });
function applyTheme(mode){
  const root = document.documentElement;
  if(mode==='auto'){ root.removeAttribute('data-theme'); if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches){ root.setAttribute('data-theme','light'); } }
  else{ root.setAttribute('data-theme', mode); }
}

const DB_NAME='biotos-crm'; const DB_STORE='kv';
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE,{keyPath:'key'});}; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});}
async function idbGet(k){try{const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readonly'); const st=tx.objectStore(DB_STORE).get(k); st.onsuccess=()=>res(st.result?st.result.val:null); st.onerror=()=>rej(st.error);}); }catch(e){return null}}
async function idbSet(k,v){try{const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); tx.objectStore(DB_STORE).put({key:k,val:v});}); }catch(e){}}

const S={get k(){return{med:'medici',far:'farmacie',vis:'visite',cfg:'cfg'}},loadLS:k=>JSON.parse(localStorage.getItem(k)||'[]'),saveLS:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),uid:()=>('id_'+Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4)),today:()=>new Date().toISOString().slice(0,10)};
let medici=[], farmacie=[], visite=[];
const savebadge=document.getElementById('savebadge'); let saveTimer=null;
function markSaving(){savebadge.textContent='Salvando…';} function markSaved(){savebadge.textContent='Salvato ✓';}
(async function initLoad(){const [m,f,v]=await Promise.all([idbGet(S.k.med),idbGet(S.k.far),idbGet(S.k.vis)]); medici=Array.isArray(m)?m:S.loadLS(S.k.med); farmacie=Array.isArray(f)?f:S.loadLS(S.k.far); visite=Array.isArray(v)?v:S.loadLS(S.k.vis); migrate(); loadCfg(); renderAll(); updateStorageUsage();})();
function persistAll(){markSaving(); clearTimeout(saveTimer); saveTimer=setTimeout(async()=>{await Promise.all([idbSet(S.k.med,medici),idbSet(S.k.far,farmacie),idbSet(S.k.vis,visite)]); S.saveLS(S.k.med,medici); S.saveLS(S.k.far,farmacie); S.saveLS(S.k.vis,visite); markSaved(); updateStorageUsage();},250);}
function migrate(){ medici=Array.isArray(medici)?medici:[]; farmacie=Array.isArray(farmacie)?farmacie:[]; visite=Array.isArray(visite)?visite:[]; }

document.querySelectorAll('.tabbtn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll(`.tabbtn[data-tab="${b.dataset.tab}"]`).forEach(x=>x.classList.add('active'));
  document.getElementById(b.dataset.tab)?.classList.remove('hidden');
  if(b.dataset.tab==='dashboard') renderDashboard();
  if(b.dataset.tab==='visite') refreshVisitRefs();
  if(b.dataset.tab==='followup') renderFollowup();
}));

const $=id=>document.getElementById(id);
const dl=(fn,text)=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'}));a.download=fn;a.click();}
const addDays=(iso,d)=>{const x=new Date(iso||new Date());x.setDate(x.getDate()+d);return x.toISOString().slice(0,10);}
function refName(v){ if(v.tipo==='Medico'){const m=medici.find(x=>x.id===v.ref); return m?`${m.titolo||''} ${m.nome||''} ${m.cognome||''}`.trim():v.ref;}
  else {const f=farmacie.find(x=>x.id===v.ref); return f?(f.ragione||v.ref):v.ref;} }
function contactInfo(v){ if(v.tipo==='Medico'){const m=medici.find(x=>x.id===v.ref); return m?(m.telefono||m.email||''):'';}
  else {const f=farmacie.find(x=>x.id===v.ref); return f?(f.telefono||f.email||''):'';} }
function toast(msg){const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600);}
function deb(fn,ms){let to; return (...a)=>{clearTimeout(to); to=setTimeout(()=>fn(...a),ms);}}
function humanSize(bytes){const u=['B','KB','MB','GB']; let i=0,v=bytes; while(v>1000 && i<u.length-1){v/=1024;i++;} return v.toFixed(1)+' '+u[i];}
function updateStorageUsage(){try{const sz=(JSON.stringify({medici,farmacie,visite}).length||0); $('stor_usage').textContent=humanSize(sz);}catch(_){ $('stor_usage').textContent='—'; }}

function renderDashboard(){
  $('k_medici').textContent=medici.length; $('k_farmacie').textContent=farmacie.length; $('k_visite').textContent=visite.length;
  const t=S.today(), s=addDays(t,3);
  $('k_fu_over').textContent=visite.filter(v=>v.follow&&v.follow<t).length;
  $('k_fu_soon').textContent=visite.filter(v=>v.follow&&v.follow>=t&&v.follow<=s).length;
  $('k_ord_fv').textContent=visite.reduce((a,v)=>a+(+v.fv||0),0); $('k_ord_fl').textContent=visite.reduce((a,v)=>a+(+v.fl||0),0);
  const tb=$('tbl_fu').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_fu'); cards.innerHTML='';
  chunk(visite.filter(v=>v.follow&&v.follow>=t&&v.follow<=s).sort((a,b)=>a.follow.localeCompare(b.follow)).slice(0,200), 30, (v)=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${v.follow}</td><td>${v.tipo}</td><td>${refName(v)}</td><td>${v.next||''}</td><td>${v.contact||''}</td>`; tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${v.follow} • ${v.tipo}<span class="chip">${refName(v)}</span></div>
      <div class="meta">${v.next||''}</div><div class="meta">${v.contact||''}</div></div>
      <div class="actions"><button class="btn" onclick="completeFU('${v.id}')">✓ Fatto</button>
      <button class="btn" onclick="postponeFU('${v.id}',1)">+1g</button><button class="btn" onclick="postponeFU('${v.id}',3)">+3g</button><button class="btn" onclick="postponeFU('${v.id}',7)">+7g</button></div>`; cards.appendChild(div);
  });
}

function chunk(arr, size, renderFn, doneFn){
  let i=0;
  function step(){
    const t=performance.now();
    for(let c=0;c<size && i<arr.length;c++,i++){ renderFn(arr[i]); if(performance.now()-t>12) break; }
    if(i<arr.length) requestAnimationFrame(step); else if(doneFn) doneFn();
  }
  requestAnimationFrame(step);
}

let editMedicoId=null, mSortAZ=true, undoStack=[];
function openMedicoSheet(id=null){
  editMedicoId=id; const title=$('sheet_medico_title');
  if(id){ const m=medici.find(x=>x.id===id); if(!m) return; title.textContent='Modifica medico';
    ['m_titolo','m_nome','m_cognome','m_spec','m_struttura','m_comune','m_indirizzo','m_tel','m_email','m_note'].forEach(k=>$(k).value=m[k.replace('m_','')]||''); }
  else { title.textContent='Nuovo medico'; ['m_titolo','m_nome','m_cognome','m_spec','m_struttura','m_comune','m_indirizzo','m_tel','m_email','m_note'].forEach(k=>$(k).value=''); }
  $('sheet_medico').classList.add('open');
}
function quickVisitForMedico(id){ openVisitaSheet(null); $('v_tipo').value='Medico'; refreshVisitRefs(); $('v_ref').value=id; }
document.getElementById('fab_medico').addEventListener('click',()=>openMedicoSheet());
document.getElementById('btn_save_medico').addEventListener('click',()=>{
  if(!$('m_nome').value.trim() || !$('m_cognome').value.trim()){ alert('Nome e Cognome sono obbligatori.'); return; }
  const m={id:editMedicoId||S.uid(), titolo:$('m_titolo').value.trim(), nome:$('m_nome').value.trim(), cognome:$('m_cognome').value.trim(),
    spec:$('m_spec').value, struttura:$('m_struttura').value.trim(), comune:$('m_comune').value.trim(), indirizzo:$('m_indirizzo').value.trim(),
    telefono:$('m_tel').value.trim(), email:$('m_email').value.trim(), note:$('m_note').value.trim()};
  if(editMedicoId){ const i=medici.findIndex(x=>x.id===editMedicoId); medici[i]=m; } else { medici.unshift(m); }
  persistAll(); closeSheets(); renderMedici();
  refreshVisitRefs(); renderDashboard(); toast('Medico salvato');
});
function renderMedici(){
  const name=($('m_q')?.value||'').toLowerCase(), comune=($('m_q_comune')?.value||'').toLowerCase(), spec=$('m_q_spec')?.value||'';
  let arr=medici.filter(m=>((m.nome+' '+m.cognome).toLowerCase().includes(name)) && (m.comune||'').toLowerCase().includes(comune) && (!spec || m.spec===spec));
  arr.sort((a,b)=> (mSortAZ?1:-1) * ( (a.cognome||'').localeCompare(b.cognome||'') || (a.nome||'').localeCompare(b.nome||'') ));
  const tb=$('tbl_medici').querySelector('tbody'); tb.innerHTML='';
  const cards=$('cards_medici'); cards.innerHTML='';
  chunk(arr, 40, (m)=>{
    const tel=m.telefono?`<a href="tel:${m.telefono}">📞 ${m.telefono}</a>`:''; const mail=m.email?`<a href="mailto:${m.email}">✉️ ${m.email}</a>`:'';
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${m.titolo||''} ${m.nome||''} ${m.cognome||''}</td>
      <td><span class="pill">${m.spec||''}</span></td>
      <td>${m.struttura||''}</td><td>${m.comune||''}</td>
      <td>${[tel,mail].filter(Boolean).join('<br>')}</td><td>${m.note||''}</td>
      <td><button class="btn" onclick="openMedicoSheet('${m.id}')">Modifica</button> <button class="btn" onclick="quickVisitForMedico('${m.id}')">+ Visita</button> <button class="btn" onclick="delMedico('${m.id}')">Elimina</button></td>`;
    tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${m.titolo||''} ${m.nome||''} ${m.cognome||''}<span class="chip">${m.spec||''}</span></div>
      <div class="subtitle">${m.struttura||''} • ${m.comune||''}</div>
      <div class="meta">${m.telefono?('<a href="tel:'+m.telefono+'">📞 '+m.telefono+'</a>'):''} ${m.email?(' · <a href="mailto:'+m.email+'">✉️ '+m.email+'</a>'):''}</div>
      <div class="meta">${m.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="openMedicoSheet('${m.id}')">Modifica</button><button class="btn" onclick="quickVisitForMedico('${m.id}')">+ Visita</button><button class="btn" onclick="delMedico('${m.id}')">Elimina</button></div>`;
    cards.appendChild(div);
  }, ()=>{ $('info_medici').textContent = `${arr.length} medici`; });
}
['m_q','m_q_comune','m_q_spec'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', deb(renderMedici, 250));});
document.getElementById('m_btn_sort').addEventListener('click', ()=>{ mSortAZ=!mSortAZ; document.getElementById('m_btn_sort').textContent = mSortAZ?'Ordina A→Z':'Ordina Z→A'; renderMedici();});
function delMedico(id){ if(!confirm('Eliminare il medico e le visite collegate?')) return;
  const backup={type:'medico', data: medici.find(x=>x.id===id), visits: visite.filter(v=>v.tipo==='Medico'&&v.ref===id)};
  undoStack.push(backup);
  medici=medici.filter(x=>x.id!==id); visite=visite.filter(v=>!(v.tipo==='Medico'&&v.ref===id));
  persistAll(); renderMedici(); renderVisite(); renderDashboard(); refreshVisitRefs(); toast('Medico eliminato. Annulla?');
  setTimeout(()=>undoStack.shift(), 7000);
}

let editFarmaciaId=null, fSortAZ=true;
function openFarmaciaSheet(id=null){
  editFarmaciaId=id; const title=$('sheet_farmacia_title');
  if(id){ const x=farmacie.find(o=>o.id===id); if(!x) return; title.textContent='Modifica farmacia';
    ['f_ragione','f_direttore','f_comune','f_indirizzo','f_tel','f_email','f_note'].forEach(k=>$(k).value=x[k.replace('f_','')]||''); }
  else { title.textContent='Nuova farmacia'; ['f_ragione','f_direttore','f_comune','f_indirizzo','f_tel','f_email','f_note'].forEach(k=>$(k).value=''); }
  $('sheet_farmacia').classList.add('open');
}
function quickVisitForFarmacia(id){ openVisitaSheet(null); $('v_tipo').value='Farmacia'; refreshVisitRefs(); $('v_ref').value=id; }
document.getElementById('fab_farmacia').addEventListener('click',()=>openFarmaciaSheet());
document.getElementById('btn_save_farmacia').addEventListener('click',()=>{
  if(!$('f_ragione').value.trim()){ alert('Ragione sociale obbligatoria.'); return; }
  const f={id:editFarmaciaId||S.uid(), ragione:$('f_ragione').value.trim(), direttore:$('f_direttore').value.trim(), comune:$('f_comune').value.trim(),
    indirizzo:$('f_indirizzo').value.trim(), telefono:$('f_tel').value.trim(), email:$('f_email').value.trim(), note:$('f_note').value.trim()};
  if(editFarmaciaId){ const i=farmacie.findIndex(o=>o.id===editFarmaciaId); farmacie[i]=f; } else { farmacie.unshift(f); }
  persistAll(); closeSheets(); renderFarmacie(); refreshVisitRefs(); renderDashboard(); toast('Farmacia salvata');
});
function renderFarmacie(){
  const q=($('f_q')?.value||'').toLowerCase(), com=($('f_q_comune')?.value||'').toLowerCase();
  let arr=farmacie.filter(x=>(x.ragione||'').toLowerCase().includes(q) && (x.comune||'').toLowerCase().includes(com));
  arr.sort((a,b)=> (fSortAZ?1:-1) * ( (a.comune||'').localeCompare(b.comune||'') || (a.ragione||'').localeCompare(b.ragione||'') ));
  const tb=$('tbl_farmacie').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_farmacie'); cards.innerHTML='';
  chunk(arr, 40, (x)=>{
    const tel=x.telefono?`<a href="tel:${x.telefono}">📞 ${x.telefono}</a>`:''; const mail=x.email?`<a href="mailto:${x.email}">✉️ ${x.email}</a>`:'';
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${x.ragione||''} ${x.direttore?'<div class=muted>'+x.direttore+'</div>':''}</td>
      <td>${x.comune||''}</td><td>${x.indirizzo||''}</td>
      <td>${[tel,mail].filter(Boolean).join('<br>')}</td><td>${x.note||''}</td>
      <td><button class="btn" onclick="openFarmaciaSheet('${x.id}')">Modifica</button> <button class="btn" onclick="quickVisitForFarmacia('${x.id}')">+ Visita</button> <button class="btn" onclick="delFarmacia('${x.id}')">Elimina</button></td>`;
    tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${x.ragione||''}<span class="chip">${x.comune||''}</span></div>
      <div class="subtitle">${x.indirizzo||''}</div>
      <div class="meta">${x.telefono?('<a href="tel:'+x.telefono+'">📞 '+x.telefono+'</a>'):''} ${x.email?(' · <a href="mailto:'+x.email+'">✉️ '+x.email+'</a>'):''}</div>
      <div class="meta">${x.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="openFarmaciaSheet('${x.id}')">Modifica</button><button class="btn" onclick="quickVisitForFarmacia('${x.id}')">+ Visita</button><button class="btn" onclick="delFarmacia('${x.id}')">Elimina</button></div>`;
    cards.appendChild(div);
  }, ()=>{ $('info_farmacie').textContent = `${arr.length} farmacie`; });
}
['f_q','f_q_comune'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', deb(renderFarmacie, 250));});
document.getElementById('f_btn_sort').addEventListener('click', ()=>{ fSortAZ=!fSortAZ; document.getElementById('f_btn_sort').textContent = fSortAZ?'Ordina A→Z':'Ordina Z→A'; renderFarmacie();});
function delFarmacia(id){ if(!confirm('Eliminare la farmacia e le visite collegate?')) return;
  const backup={type:'farmacia', data: farmacie.find(x=>x.id===id), visits: visite.filter(v=>v.tipo==='Farmacia'&&v.ref===id)};
  undoStack.push(backup);
  farmacie=farmacie.filter(x=>x.id!==id); visite=visite.filter(v=>!(v.tipo==='Farmacia'&&v.ref===id));
  persistAll(); renderFarmacie(); renderVisite(); renderDashboard(); refreshVisitRefs(); toast('Farmacia eliminata. Annulla?');
  setTimeout(()=>undoStack.shift(), 7000);
}

let editVisitaId=null, vSortRecent=true;
function openVisitaSheet(id=null, duplicate=false){
  editVisitaId = duplicate ? null : id; const title=$('sheet_visita_title');
  if(id){ const v=visite.find(o=>o.id===id); if(!v) return; title.textContent= duplicate ? 'Duplica visita' : 'Modifica visita';
    ['v_data','v_tipo','v_ref','v_refe','v_obj','v_prod','v_mat','v_esito','v_next','v_follow','v_fv','v_fl','v_note'].forEach(k=>{$(k).value=(v[k.replace('v_','')]??'');});
    if(duplicate){ $('v_data').value = S.today(); }
  }else{ title.textContent='Nuova visita'; ['v_data','v_obj','v_mat','v_follow','v_note'].forEach(k=>$(k).value=''); $('v_fv').value=0; $('v_fl').value=0; $('v_tipo').value='Medico'; $('v_refe').value='Stefano'; }
  refreshVisitRefs(); $('sheet_visita').classList.add('open');
}
document.getElementById('fab_visita').addEventListener('click',()=>openVisitaSheet());
document.getElementById('btn_save_visita').addEventListener('click',()=>{
  if(!$('v_data').value || !$('v_tipo').value || !$('v_ref').value){ alert('Compila data, tipo e riferimento.'); return; }
  const v={id:editVisitaId||S.uid(),data:$('v_data').value||S.today(),tipo:$('v_tipo').value,ref:$('v_ref').value,refe:$('v_refe').value,
    obj:$('v_obj').value.trim(),prod:$('v_prod').value,mat:$('v_mat').value.trim(),esito:$('v_esito').value,
    next:$('v_next').value,follow:$('v_follow').value||'',fv:+$('v_fv').value||0,fl:+$('v_fl').value||0,note:$('v_note').value.trim(),
    contact:contactInfo({tipo:$('v_tipo').value,ref:$('v_ref').value})};
  if(!v.follow && v.next){ v.follow = addDays(v.data,7); }
  if(editVisitaId){ const i=visite.findIndex(o=>o.id===editVisitaId); visite[i]=v; } else { visite.unshift(v); }
  persistAll(); closeSheets(); renderVisite(); renderDashboard(); renderFollowup(); toast('Visita salvata');
});
document.querySelectorAll('.quickchips [data-addd]').forEach(b=>b.addEventListener('click',()=>{
  const d= parseInt(b.getAttribute('data-addd')); $('v_follow').value = addDays($('v_data').value||S.today(), d);
}));
function refreshVisitRefs(){const sel=$('v_ref'); if(!sel) return; sel.innerHTML=''; const tipo=$('v_tipo').value; const list=(tipo==='Medico'?medici:farmacie);
  list.forEach(x=>{const opt=document.createElement('option'); opt.value=x.id; opt.textContent=(tipo==='Medico'?`${x.titolo||''} ${x.nome||''} ${x.cognome||''}`.trim():(x.ragione||x.id)); sel.appendChild(opt);});}
$('v_tipo').addEventListener('change',refreshVisitRefs);

function renderVisite(){
  const from=$('v_q_from')?.value||'', to=$('v_q_to')?.value||'', tipo=$('v_q_tipo')?.value||'', esito=$('v_q_esito')?.value||'', prod=$('v_q_prod')?.value||'';
  let arr=visite.filter(v=>{
    const okDate = (!from || v.data>=from) && (!to || v.data<=to);
    const okTipo = (!tipo || v.tipo===tipo);
    const okEsito = (!esito || v.esito===esito);
    const okProd = (!prod || v.prod===prod);
    return okDate && okTipo && okEsito && okProd;
  });
  arr.sort((a,b)=> (vSortRecent?-1:1) * a.data.localeCompare(b.data) );
  const tb=$('tbl_visite').querySelector('tbody'); tb.innerHTML='';
  const cards=$('cards_visite'); cards.innerHTML='';
  chunk(arr, 50, (v)=>{
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${v.data}</td><td>${v.tipo}</td><td>${refName(v)}</td>
      <td>${v.prod}</td><td>${v.esito}</td><td>${v.next||''}</td><td>${v.follow||''}</td>
      <td>${v.refe}</td><td>${v.fv||0}/${v.fl||0}</td><td>${v.note||''}</td>
      <td><button class="btn" onclick="openVisitaSheet('${v.id}')">Modifica</button> <button class="btn" onclick="openVisitaSheet('${v.id}',true)">Duplica</button> <button class="btn" onclick="delVisita('${v.id}')">Elimina</button></td>`;
    tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${v.data} • ${v.tipo}<span class="chip">${refName(v)}</span></div>
      <div class="subtitle">${v.refe} – Prodotti: ${v.prod}</div>
      <div class="meta">Esito: ${v.esito}${v.follow?(' • FU: '+v.follow):''}${v.next?(' • '+v.next):''}</div>
      <div class="meta">${v.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="openVisitaSheet('${v.id}')">Modifica</button><button class="btn" onclick="openVisitaSheet('${v.id}',true)">Duplica</button><button class="btn" onclick="delVisita('${v.id}')">Elimina</button></div>`;
    cards.appendChild(div);
  }, ()=>{ $('info_visite').textContent = `${arr.length} visite`; });
}
['v_q_from','v_q_to','v_q_tipo','v_q_esito','v_q_prod'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', deb(renderVisite, 200));});
document.getElementById('v_btn_sort').addEventListener('click', ()=>{ vSortRecent=!vSortRecent; document.getElementById('v_btn_sort').textContent = vSortRecent?'Ordina recenti':'Ordina vecchie'; renderVisite();});
function delVisita(id){ visite=visite.filter(v=>v.id!==id); persistAll(); renderVisite(); renderDashboard(); renderFollowup(); toast('Visita eliminata'); }

function renderFollowup(){
  const mode=$('fu_state').value, t=S.today(), s=addDays(t,3);
  let data=visite.filter(v=>v.follow); if(mode==='over') data=data.filter(v=>v.follow<t); if(mode==='soon') data=data.filter(v=>v.follow>=t&&v.follow<=s); if(mode==='future') data=data.filter(v=>v.follow>s);
  data.sort((a,b)=>a.follow.localeCompare(b.follow));
  const tb=$('tbl_follow').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_follow'); cards.innerHTML='';
  chunk(data, 50, (v)=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${v.follow}</td><td>${v.tipo}</td><td>${refName(v)}</td><td>${v.next||''}</td><td>${v.contact||''}</td><td>${v.note||''}</td>
      <td><button class="btn" onclick="completeFU('${v.id}')">✓ Fatto</button> <button class="btn" onclick="postponeFU('${v.id}',1)">+1g</button> <button class="btn" onclick="postponeFU('${v.id}',3)">+3g</button> <button class="btn" onclick="postponeFU('${v.id}',7)">+7g</button></td>`; tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${v.follow} • ${v.tipo}<span class="chip">${refName(v)}</span></div>
      <div class="meta">${v.next||''}</div><div class="meta">${v.contact||''}</div><div class="meta">${v.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="completeFU('${v.id}')">✓ Fatto</button><button class="btn" onclick="postponeFU('${v.id}',1)">+1g</button><button class="btn" onclick="postponeFU('${v.id}',3)">+3g</button><button class="btn" onclick="postponeFU('${v.id}',7)">+7g</button></div>`;
    cards.appendChild(div);
  });
}
function completeFU(id){ const v=visite.find(x=>x.id===id); if(!v) return; v.follow=''; v.next=''; persistAll(); renderFollowup(); renderDashboard(); toast('Follow-up completato'); }
function postponeFU(id,days){ const v=visite.find(x=>x.id===id); if(!v || !v.follow) return; v.follow = addDays(v.follow,days); persistAll(); renderFollowup(); toast('Follow-up posticipato'); }

document.getElementById('btn_exp_ics').addEventListener('click',()=>{
  const evs=visite.filter(v=>v.follow); const L=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Biotos CRM//FollowUps//IT']; const ts=new Date().toISOString().replace(/[-:]/g,'').slice(0,15)+'Z';
  evs.forEach(v=>{const dt=(v.follow||'').replace(/-/g,''); const s='Follow-up: '+(refName(v)||'')+(v.next?(' – '+v.next):''); const d='Contatto: '+(v.contact||''); L.push('BEGIN:VEVENT','UID:'+v.id+'@biotoscrm','DTSTAMP:'+ts,'DTSTART;VALUE=DATE:'+dt,'SUMMARY:'+s,'DESCRIPTION:'+d,'END:VEVENT');});
  L.push('END:VCALENDAR'); dl('biotos_followups.ics',L.join('\r\n'));
});
document.getElementById('btn_exp_json').addEventListener('click', ()=>{
  const payload = { exportedAt: new Date().toISOString(), version: 'v8.0', medici, farmacie, visite };
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'})); a.download='biotos_crm_backup.json'; a.click();
});
document.getElementById('inp_imp_json').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const rd = new FileReader(); rd.onload = () => {
    try{
      const obj = JSON.parse(rd.result); medici = obj.medici||[]; farmacie = obj.farmacie||[]; visite = obj.visite||[];
      persistAll(); renderAll(); alert('Backup importato con successo');
    }catch(err){ alert('File non valido'); }
  }; rd.readAsText(f);
});
document.getElementById('btn_clear').addEventListener('click', ()=>{ if(!confirm('Cancellare tutti i dati?')) return; medici=[]; farmacie=[]; visite=[]; persistAll(); renderAll(); toast('Dati azzerati'); });

function saveCfg(cfg){ localStorage.setItem('gh_cfg', JSON.stringify(cfg)); }
function loadCfg(){ try{ const cfg = JSON.parse(localStorage.getItem('gh_cfg')||'null'); if(!cfg) return;
  $('gh_owner').value=cfg.owner||''; $('gh_repo').value=cfg.repo||''; $('gh_branch').value=cfg.branch||'main'; $('gh_path').value=cfg.path||'biotos_crm_data.json'; $('gh_token').value=cfg.token||''; }catch(_){ } }
function getGH(){const cfg={owner:$('gh_owner').value.trim(), repo:$('gh_repo').value.trim(), branch:$('gh_branch').value.trim()||'main', path:$('gh_path').value.trim()||'biotos_crm_data.json', token:$('gh_token').value.trim()}; saveCfg(cfg); return cfg;}
async function ghGetFileMeta(cfg){
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}?ref=${cfg.branch}`;
  const r = await fetch(url, {headers:{'Authorization': 'Bearer '+cfg.token, 'Accept':'application/vnd.github+json'}});
  if(r.status===404) return null;
  if(!r.ok) throw new Error('Errore GET: '+r.status);
  return await r.json();
}
async function ghPull(){
  const cfg=getGH(); if(!cfg.owner||!cfg.repo||!cfg.token){ alert('Compila owner, repo e token.'); return; }
  try{
    const meta = await ghGetFileMeta(cfg);
    if(!meta){ alert('File non trovato nel repo/branch indicati.'); return; }
    const txt = atob(meta.content.replace(/\n/g,''));
    const obj = JSON.parse(txt);
    medici = obj.medici||[]; farmacie = obj.farmacie||[]; visite = obj.visite||[];
    persistAll(); renderAll(); toast('Sync pull completato');
  }catch(e){ alert('Pull fallito: '+e.message); }
}
async function ghPush(){
  const cfg=getGH(); if(!cfg.owner||!cfg.repo||!cfg.token){ alert('Compila owner, repo e token.'); return; }
  try{
    const meta = await ghGetFileMeta(cfg);
    const sha = meta? meta.sha : undefined;
    const body = {
      message: 'Update from Biotos CRM v8.0',
      content: btoa(unescape(encodeURIComponent(JSON.stringify({medici,farmacie,visite},null,2)))),
      branch: cfg.branch
    };
    if(sha) body.sha = sha;
    const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}`;
    const r = await fetch(url, {method:'PUT', headers:{'Authorization': 'Bearer '+cfg.token, 'Accept':'application/vnd.github+json'}, body: JSON.stringify(body)});
    if(!r.ok) throw new Error('Errore PUT: '+r.status);
    toast('Sync push completato');
  }catch(e){ alert('Push fallito: '+e.message); }
}
document.getElementById('btn_pull').addEventListener('click', ghPull);
document.getElementById('btn_push').addEventListener('click', ghPush);

function closeSheets(){ document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('open')); }
document.querySelectorAll('.sheet .close').forEach(b=>b.addEventListener('click',()=>{ closeSheets(); }));
window.addEventListener('keydown',e=>{ if(e.key==='Escape') closeSheets(); });
document.getElementById('btn_reload').addEventListener('click', ()=>{ window.location.reload(); });

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').then(reg=>{
    if(reg.waiting){ document.getElementById('upd').classList.add('show'); }
    reg.addEventListener('updatefound', ()=>{
      const sw = reg.installing;
      sw.addEventListener('statechange', ()=>{
        if(sw.state==='installed' && navigator.serviceWorker.controller){
          document.getElementById('upd').classList.add('show');
        }
      });
    });
  }).catch(()=>{});
}

function renderAll(){ renderMedici(); renderFarmacie(); refreshVisitRefs(); renderVisite(); renderDashboard(); renderFollowup(); }
</script>
</body>
</html>
