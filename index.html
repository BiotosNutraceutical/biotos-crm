<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Biotos CRM – v1.4 (Complete)</title>
<meta name="theme-color" content="#0b8f5c">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
:root{
  --bg:#07130e; --panel:#0c2319; --panel2:#0a1c15; --muted:#cfeadd; --text:#f6fffa;
  --accent:#0b8f5c; --accent-2:#10b97a; --line:#1a563b; --danger:#ff6b6b; --ok:#28d07e;
  --nav-h:50px;
}
[data-theme="light"]{
  --bg:#f7fbf8; --panel:#ffffff; --panel2:#f2f7f4; --muted:#3b5b4b; --text:#0b2017; --line:#d7e8df;
  --accent:#0b8f5c; --accent-2:#087e52;
}
[data-theme="hc"]{
  --bg:#000; --panel:#000; --panel2:#000; --muted:#d0fff0; --text:#fff; --line:#3ddc97; --accent:#3ddc97; --accent-2:#aaffcc;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.55 -apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
.hidden{display:none !important}
.muted{color:var(--muted)}
header{position:sticky;top:0;background:var(--bg);z-index:50;padding-top:calc(2px + env(safe-area-inset-top));border-bottom:1px solid rgba(23,86,59,.35)}
.wrap{max-width:1100px;margin:0 auto;padding:6px 12px 2px}
h1{font-size:16px;margin:0;display:flex;align-items:center;gap:8px}
h1 img{width:22px;height:22px;border-radius:6px;border:1px solid var(--line);background:#fff}
.savebadge{margin-left:auto;font-size:11px;color:#bfe5cf}
.profilebadge{margin-left:10px;font-size:12px;color:#a5e9cb;opacity:.9}
.globalsearch{margin:6px 0 6px;display:flex;gap:8px;align-items:center}
.globalsearch input{flex:1;background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-height:40px;color:var(--text)}
.globalsearch .btn{white-space:nowrap}
.bottomnav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--line);
display:flex;gap:6px;padding:4px env(safe-area-inset-right) calc(6px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
z-index:45;height:var(--nav-h);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.bottomnav::-webkit-scrollbar{display:none}
.bottomnav button{flex:0 0 auto;min-width:84px;border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:6px 8px;border-radius:10px;min-height:36px;font-size:13px}
.bottomnav button.active{border-color:var(--accent);background:rgba(11,143,92,.18)}
@media (max-width:430px){ .bottomnav button span.label{display:none} .bottomnav button{min-width:52px} }
.grid{display:grid;gap:10px}
.pan{background:var(--panel);padding:10px;border-radius:14px;border:1px solid var(--line)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row>*{flex:1 1 260px}
.right{display:flex;align-items:flex-end;justify-content:flex-end}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--line);border-radius:12px;padding:12px;min-height:42px;font-size:16px}
.btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#103024;color:var(--text);padding:9px 11px;border-radius:12px;cursor:pointer;min-height:38px}
.btn.primary{border-color:var(--accent);background:linear-gradient(180deg, rgba(11,143,92,.22), rgba(11,143,92,.12))}
.btn.ghost{background:transparent}
.cards{display:grid;gap:8px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;gap:10px}
.card .main{flex:1;min-width:0}
.card .title{font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card .meta{font-size:13px;color:#cfe8dc}
.fab{position:fixed;right:16px;bottom:calc(var(--nav-h) + 18px + env(safe-area-inset-bottom));width:56px;height:56px;border-radius:50%;
display:flex;align-items:center;justify-content:center;background:var(--accent);color:#07170f;font-weight:800;border:0;z-index:44;box-shadow:0 10px 26px rgba(0,0,0,.45)}
.fabmenu{position:fixed;right:16px;bottom:calc(var(--nav-h) + 82px + env(safe-area-inset-bottom));display:none;flex-direction:column;gap:8px;z-index:46}
.fabmenu.show{display:flex}
.sheet{position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);z-index:60}
.sheet.open{display:block}
.sheet .panel{position:absolute;left:0;right:0;bottom:0;background:#0c2219;border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
padding:10px 10px calc(12px + env(safe-area-inset-bottom));max-height:90vh;overflow:auto}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--nav-h) + 20px + env(safe-area-inset-bottom));background:#0f2e22;border:1px solid var(--line);padding:8px 12px;border-radius:12px;z-index:70;display:none}
.toast.show{display:block}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
.chips .chip{border:1px solid var(--line);background:var(--panel2);padding:4px 8px;border-radius:999px;font-size:12px;cursor:pointer}
.chips .chip.on{border-color:var(--accent);background:rgba(11,143,92,.14)}
.onboarding{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;z-index:80;align-items:center;justify-content:center;padding:18px}
.onboarding.show{display:flex}
.onboarding .box{background:var(--panel);border:1px solid var(--line);border-radius:16px;max-width:520px;width:100%;padding:14px}
.onboarding h3{margin:6px 0 8px}
.onboarding p{margin:6px 0 8px}
@media (min-width:900px){ .bottomnav{display:none} .wrap{padding-bottom:20px} .fab{right:24px; bottom:24px} }
@media (max-width:899px){ .wrap{padding-bottom:calc(var(--nav-h) + 60px)} }
button{border:0} button.btn,.tabbtn{user-select:none}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><img src="icons/icon-192.png" alt=""> Biotos CRM <span class="muted">v1.4 (Complete)</span>
      <span class="savebadge" id="savebadge">Salvato ✓</span>
      <span class="profilebadge" id="profilebadge"></span>
    </h1>
    <div class="globalsearch">
      <input id="gsearch" placeholder="Cerca ovunque… (invio per aprire risultati)" autocomplete="off">
      <button class="btn" id="btn_backup">⬇️ Backup</button>
      <label class="btn" for="inp_restore">⬆️ Ripristina</label><input id="inp_restore" type="file" accept="application/json" style="display:none">
    </div>
  </div>
</header>

<main class="wrap" id="mainwrap">
  <section id="dashboard" class="grid">
    <div class="pan">
      <div class="row">
        <div><label>Medici</label><input id="k_medici" disabled></div>
        <div><label>Farmacie</label><input id="k_farmacie" disabled></div>
        <div><label>Visite</label><input id="k_visite" disabled></div>
        <div><label>Appuntamenti futuri</label><input id="k_appt" disabled></div>
      </div>
    </div>
    <div class="pan">
      <h3 style="margin:4px 0 8px">Prossime attività</h3>
      <div class="cards" id="cards_dash"></div>
    </div>
  </section>

  <section id="medici" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Filtro nome</label><input id="m_q"></div>
        <div><label>Comune</label><input id="m_q_comune"></div>
        <div><label>Specialità</label>
          <select id="m_q_spec">
            <option value="">Tutte</option><option>Ginecologia</option><option>MMG</option><option>Altro</option>
          </select>
        </div>
        <div><label>Tag</label><input id="m_q_tag" placeholder="es. top, FV"></div>
        <div class="right"><label>&nbsp;</label><button class="btn primary" id="btn_new_med">+ Medico</button></div>
      </div>
      <div class="chips" id="m_chips"></div>
      <div class="row">
        <button class="btn" id="btn_exp_med">⬇️ Export CSV</button>
        <label class="btn" for="inp_imp_med">⬆️ Import CSV</label><input id="inp_imp_med" type="file" accept=".csv,text/csv" style="display:none">
      </div>
      <div class="cards" id="cards_medici"></div>
    </div>
  </section>

  <section id="farmacie" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Filtro nome</label><input id="f_q"></div>
        <div><label>Comune</label><input id="f_q_comune"></div>
        <div><label>Tag</label><input id="f_q_tag" placeholder="es. FV, vetrina"></div>
        <div class="right"><label>&nbsp;</label><button class="btn primary" id="btn_new_far">+ Farmacia</button></div>
      </div>
      <div class="chips" id="f_chips"></div>
      <div class="row">
        <button class="btn" id="btn_exp_far">⬇️ Export CSV</button>
        <label class="btn" for="inp_imp_far">⬆️ Import CSV</label><input id="inp_imp_far" type="file" accept=".csv,text/csv" style="display:none">
      </div>
      <div class="cards" id="cards_farmacie"></div>
    </div>
  </section>

  <section id="visite" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Dal</label><input type="date" id="v_q_from"></div>
        <div><label>Al</label><input type="date" id="v_q_to"></div>
        <div><label>Tipo</label><select id="v_q_tipo"><option value="">Tutti</option><option>Medico</option><option>Farmacia</option></select></div>
        <div><label>Tag</label><input id="v_q_tag" placeholder="es. FU, demo"></div>
        <div class="right"><label>&nbsp;</label><button class="btn primary" id="btn_new_vis">+ Visita</button></div>
      </div>
      <div class="chips" id="v_chips"></div>
      <div class="row">
        <button class="btn" id="btn_exp_vis">⬇️ Export CSV</button>
        <label class="btn" for="inp_imp_vis">⬆️ Import CSV</label><input id="inp_imp_vis" type="file" accept=".csv,text/csv" style="display:none">
      </div>
      <div class="cards" id="cards_visite"></div>
    </div>
  </section>

  <section id="agenda" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Dal</label><input type="date" id="a_from"></div>
        <div><label>Al</label><input type="date" id="a_to"></div>
        <div class="right"><label>&nbsp;</label><button class="btn primary" id="btn_new_appt">+ Appuntamento</button></div>
      </div>
      <div class="cards" id="cards_agenda"></div>
    </div>
  </section>

  <section id="followup" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Stato</label>
          <select id="fu_state"><option value="all">Tutti</option><option value="over">Scaduti</option><option value="soon">Prossimi 3 gg</option><option value="future">Oltre 3 gg</option></select>
        </div>
        <div class="right"><label>&nbsp;</label><button class="btn" id="btn_exp_ics">📅 iCal</button></div>
      </div>
      <div class="cards" id="cards_follow"></div>
    </div>
  </section>

  <section id="report" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Mese</label><input type="month" id="r_month"></div>
        <div><label>Referente</label><select id="r_refe"><option value="">Tutti</option><option>Stefano</option><option>Mariangela</option></select></div>
        <div class="right"><label>&nbsp;</label><button class="btn" id="btn_exp_rep">⬇️ CSV</button></div>
      </div>
      <div class="row">
        <div><label>Visite mese</label><input id="rk_visite" disabled></div>
        <div><label>Nuovi contatti</label><input id="rk_nuovi" disabled></div>
        <div><label>FU creati</label><input id="rk_fu" disabled></div>
        <div><label>Ordini stimati FV/FL</label><input id="rk_ord" disabled></div>
      </div>
      <div class="cards" id="cards_rep"></div>
    </div>
  </section>

  <section id="io" class="grid hidden">
    <div class="pan">
      <h3 style="margin:0 0 8px">Impostazioni & Account</h3>
      <div class="row">
        <div><label>Tema</label><select id="themeSel"><option value="auto">Auto</option><option value="dark">Scuro</option><option value="light">Chiaro</option><option value="hc">Contrasto alto</option></select></div>
        <div><label>Default follow-up (giorni)</label><input id="cfg_fu" type="number" value="7" min="0"></div>
      </div>
      <div class="row">
        <div><label>Profilo corrente</label><select id="profileSel"></select></div>
        <div><label>Nuovo profilo</label><input id="profileNew" placeholder="es. Mariangela"></div>
        <div class="right"><label>&nbsp;</label><button class="btn" id="btn_add_profile">+ Crea profilo</button></div>
      </div>
      <div class="row">
        <div><label>Modalità master</label>
          <select id="masterMode"><option value="off">Off</option><option value="impersonate">Impersona (switch)</option></select>
        </div>
        <div><label>Esporta profilo</label><button class="btn" id="btn_exp_profile">⬇️ JSON</button></div>
        <div><label>Importa profilo</label><label class="btn" for="inp_imp_profile">⬆️ JSON</label><input id="inp_imp_profile" type="file" accept="application/json" style="display:none"></div>
      </div>
    </div>
  </section>
</main>

<nav class="bottomnav" id="bottomnav" aria-label="Sezioni">
  <button type="button" class="tabbtn active" data-tab="dashboard"><span>🏠</span> <span class="label">Home</span></button>
  <button type="button" class="tabbtn" data-tab="medici"><span>👩‍⚕️</span> <span class="label">Medici</span></button>
  <button type="button" class="tabbtn" data-tab="farmacie"><span>💊</span> <span class="label">Farmacie</span></button>
  <button type="button" class="tabbtn" data-tab="visite"><span>📝</span> <span class="label">Visite</span></button>
  <button type="button" class="tabbtn" data-tab="agenda"><span>🗓️</span> <span class="label">Agenda</span></button>
  <button type="button" class="tabbtn" data-tab="followup"><span>⏰</span> <span class="label">F/U</span></button>
  <button type="button" class="tabbtn" data-tab="report"><span>📈</span> <span class="label">Report</span></button>
  <button type="button" class="tabbtn" data-tab="io"><span>⚙️</span> <span class="label">Dati</span></button>
</nav>

<button class="fab" id="fab" title="Azioni" aria-label="Nuova azione">＋</button>
<div class="fabmenu" id="fabmenu" role="menu" aria-label="Azioni rapide">
  <button class="btn" id="act_new_med">+ Medico</button>
  <button class="btn" id="act_new_far">+ Farmacia</button>
  <button class="btn" id="act_new_vis">+ Visita</button>
  <button class="btn" id="act_new_appt2">+ Appuntamento</button>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- SHEETS -->
<div class="sheet" id="sheet_medico"><div class="panel">
  <button class="close" data-close="sheet_medico" aria-label="Chiudi">✕</button><h3>Nuovo medico</h3>
  <div class="row">
    <div><label>Titolo</label><select id="m_tit"><option>Dott.</option><option>Dott.ssa</option><option>Prof.</option></select></div>
    <div><label>Nome *</label><input id="m_nome" required></div>
    <div><label>Cognome *</label><input id="m_cognome" required></div>
  </div>
  <div class="row">
    <div><label>Specialità</label><select id="m_spec"><option>Ginecologia</option><option>MMG</option><option>Altro</option></select></div>
    <div><label>Struttura</label><input id="m_strutt"></div>
    <div><label>Comune</label><input id="m_comune"></div>
  </div>
  <div class="row">
    <div><label>Telefono</label><input id="m_tel"></div>
    <div><label>Email</label><input id="m_email" autocapitalize="none"></div>
    <div><label>Tag</label><input id="m_tag" placeholder="es. top, FV"></div>
  </div>
  <div class="row"><div><label>Note</label><textarea id="m_note"></textarea></div></div>
  <div class="row"><button id="btn_save_medico" class="btn primary" type="button">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_farmacia"><div class="panel">
  <button class="close" data-close="sheet_farmacia" aria-label="Chiudi">✕</button><h3>Nuova farmacia</h3>
  <div class="row"><div><label>Ragione sociale *</label><input id="f_ragione" required></div><div><label>Direttore</label><input id="f_dir"></div><div><label>Comune</label><input id="f_comune"></div></div>
  <div class="row"><div><label>Telefono</label><input id="f_tel"></div><div><label>Email</label><input id="f_email" autocapitalize="none"></div><div><label>Tag</label><input id="f_tag" placeholder="es. FV, vetrina"></div></div>
  <div class="row"><div><label>Indirizzo</label><input id="f_addr"></div><div><label>Note</label><input id="f_note"></div></div>
  <div class="row"><button id="btn_save_farmacia" class="btn primary" type="button">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_visita"><div class="panel">
  <button class="close" data-close="sheet_visita" aria-label="Chiudi">✕</button><h3>Nuova visita</h3>
  <div class="row"><div><label>Data *</label><input id="v_data" type="date"></div>
  <div><label>Tipo *</label><select id="v_tipo"><option>Medico</option><option>Farmacia</option></select></div>
  <div><label>Riferimento *</label><select id="v_ref"></select></div></div>
  <div class="row"><div><label>Prodotti</label><select id="v_prod"><option>FV</option><option>FL</option><option>Entrambi</option><option>—</option></select></div>
  <div><label>Esito</label><select id="v_esito"><option>Incontro svolto</option><option>Rifiutato</option><option>Assente</option><option>Solo materiale</option><option>Nuovo contatto</option></select></div>
  <div><label>Referente</label><select id="v_refe"><option>Stefano</option><option>Mariangela</option></select></div></div>
  <div class="row"><div><label>Materiale</label><input id="v_mat"></div><div><label>Next step</label><input id="v_next"></div><div><label>Follow-up</label><input id="v_follow" type="date"></div></div>
  <div class="row"><div><label>Ordini stimati FV</label><input id="v_fv" type="number" min="0" value="0"></div><div><label>Ordini stimati FL</label><input id="v_fl" type="number" min="0" value="0"></div><div><label>Tag</label><input id="v_tag" placeholder="es. FV demo"></div></div>
  <div class="row"><div><label>Note</label><textarea id="v_note"></textarea></div></div>
  <div class="row"><button id="btn_save_visita" class="btn primary" type="button">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_appt"><div class="panel">
  <button class="close" data-close="sheet_appt" aria-label="Chiudi">✕</button><h3>Nuovo appuntamento</h3>
  <div class="row"><div><label>Data *</label><input id="a_data" type="date"></div><div><label>Ora</label><input id="a_ora" type="time"></div></div>
  <div class="row"><div><label>Titolo *</label><input id="a_tit"></div><div><label>Tipo</label><select id="a_tipo"><option>Medico</option><option>Farmacia</option></select></div><div><label>Rif.</label><select id="a_ref"></select></div></div>
  <div class="row"><div><label>Note</label><input id="a_note"></div></div>
  <div class="row"><button id="btn_save_appt" class="btn primary" type="button">Salva</button></div>
</div></div>

<div class="onboarding" id="onboarding">
  <div class="box">
    <h3>Benvenuto in Biotos CRM</h3>
    <p>• Crea <strong>profili</strong> per ogni collaboratore nelle <strong>Impostazioni</strong> (master: impersona chi vuoi).<br>
       • Aggiungi contatti col pulsante <strong>＋</strong>, pianifica in <strong>Agenda</strong> e converti in <strong>Visita</strong> 1-click.<br>
       • Gestisci <strong>Follow-up</strong> con +1/+3/+7 e invia <strong>iCal</strong>. Fai <strong>Backup</strong>/<strong>Restore</strong> o CSV.</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <label><input type="checkbox" id="dontshow"> Non mostrare più</label>
      <button class="btn primary" id="ok_onb">Inizia</button>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
function tISO(d=new Date()){return new Date(d).toISOString().slice(0,10)}
function uid(){return 'id_'+Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4)}
function showToast(t){const el=$('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1600);}
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

/* ======= PROFILI (ACCOUNT) ======= */
function slug(s){ return (s||'default').toLowerCase().replace(/[^a-z0-9]+/g,'-'); }
let PROFILES = JSON.parse(localStorage.getItem('biotos:profiles')||'["default"]');
let CURRENT = localStorage.getItem('biotos:current') || PROFILES[0] || 'default';
function saveProfiles(){ localStorage.setItem('biotos:profiles', JSON.stringify(Array.from(new Set(PROFILES)))); localStorage.setItem('biotos:current', CURRENT); }
function setProfile(name){
  CURRENT = name; saveProfiles();
  $('profilebadge').textContent = 'Profilo: '+CURRENT;
  boot(true);
}
function ensureProfileListUI(){
  const sel=$('profileSel'); sel.innerHTML='';
  PROFILES.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; if(p===CURRENT) o.selected=true; sel.appendChild(o); });
  $('profilebadge').textContent = 'Profilo: '+CURRENT;
}
$('btn_add_profile').addEventListener('click', ()=>{
  const n = ($('profileNew').value||'').trim(); if(!n) return alert('Nome profilo?');
  if(!PROFILES.includes(n)) PROFILES.push(n);
  saveProfiles(); ensureProfileListUI(); showToast('Profilo creato');
});
$('profileSel').addEventListener('change', e=> setProfile(e.target.value));

/* ======= DATI E DB ======= */
let medici=[], farmacie=[], visite=[], appuntamenti=[];
let db=null, DBNAME=null;
function idbOpen(){ return new Promise((res,rej)=>{
  const r=indexedDB.open(DBNAME,'1');
  r.onupgradeneeded=(e)=>{ const d=e.target.result;
    d.createObjectStore('medici',{keyPath:'id'});
    d.createObjectStore('farmacie',{keyPath:'id'});
    d.createObjectStore('visite',{keyPath:'id'});
    d.createObjectStore('appuntamenti',{keyPath:'id'});
  };
  r.onsuccess=()=>{ db=r.result; res(); };
  r.onerror=()=>rej(r.error);
});}
function idbClearAll(){ return Promise.all(['medici','farmacie','visite','appuntamenti'].map(store=>new Promise((res)=>{
  const tx=db.transaction(store,'readwrite'); tx.objectStore(store).clear().onsuccess=()=>res();
})));}
function idbBulkPut(store, arr){ return new Promise((res)=>{
  const tx=db.transaction(store,'readwrite'); const os=tx.objectStore(store);
  arr.forEach(x=>os.put(x)); tx.oncomplete=()=>res();
});}
function idbLoadAll(store){ return new Promise((res)=>{
  const tx=db.transaction(store,'readonly'); const os=tx.objectStore(store); const out=[];
  os.openCursor().onsuccess=(e)=>{ const c=e.target.result; if(c){ out.push(c.value); c.continue(); } else res(out); };
});}

async function saveAll(){
  localStorage.setItem('biotos:'+CURRENT+':data', JSON.stringify({medici,farmacie,visite,appuntamenti}));
  try{
    if(db){ await idbClearAll(); await idbBulkPut('medici', medici); await idbBulkPut('farmacie', farmacie); await idbBulkPut('visite', visite); await idbBulkPut('appuntamenti', appuntamenti); }
    $('savebadge').textContent='Salvato ✓';
  }catch(err){ console.error(err); $('savebadge').textContent='⚠︎ Non salvato'; }
}
async function loadAll(){
  try{
    DBNAME='biotos-crm-'+slug(CURRENT);
    await idbOpen();
    const m=await idbLoadAll('medici'); const f=await idbLoadAll('farmacie');
    const v=await idbLoadAll('visite'); const a=await idbLoadAll('appuntamenti');
    if(m.length||f.length||v.length||a.length){ medici=m; farmacie=f; visite=v; appuntamenti=a; return; }
  }catch(_){ }
  try{ const j=JSON.parse(localStorage.getItem('biotos:'+CURRENT+':data')||'{}'); medici=j.medici||[]; farmacie=j.farmacie||[]; visite=j.visite||[]; appuntamenti=j.appuntamenti||[]; }catch(_){}
}

/* ======= NAV ======= */
function openTab(tab){
  document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll(`.tabbtn[data-tab="${tab}"]`).forEach(x=>x.classList.add('active'));
  document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
  const sec=document.getElementById(tab); if(sec) sec.classList.remove('hidden');
  window.scrollTo({top:0, behavior:'smooth'});
}
document.addEventListener('click', (e)=>{
  const tb=e.target.closest('.tabbtn'); if(tb && tb.dataset.tab){ e.preventDefault(); openTab(tb.dataset.tab); }
  const close=e.target.closest('.close'); if(close){ close.closest('.sheet').classList.remove('open'); }
});

/* ======= FAB ======= */
const fab=$('fab'), menu=$('fabmenu');
fab.addEventListener('click',()=> menu.classList.toggle('show'));
document.addEventListener('click',(e)=>{ if(!fab.contains(e.target) && !menu.contains(e.target)) menu.classList.remove('show'); });
$('act_new_med').addEventListener('click',()=>{ menu.classList.remove('show'); $('sheet_medico').classList.add('open'); });
$('act_new_far').addEventListener('click',()=>{ menu.classList.remove('show'); $('sheet_farmacia').classList.add('open'); });
$('act_new_vis').addEventListener('click',()=>{ menu.classList.remove('show'); refreshRefs(); $('sheet_visita').classList.add('open'); });
$('act_new_appt2').addEventListener('click',()=>{ menu.classList.remove('show'); refreshRefs(); $('sheet_appt').classList.add('open'); });
$('btn_new_med')?.addEventListener('click',()=> $('sheet_medico').classList.add('open'));
$('btn_new_far')?.addEventListener('click',()=> $('sheet_farmacia').classList.add('open'));
$('btn_new_vis')?.addEventListener('click',()=> { refreshRefs(); $('sheet_visita').classList.add('open'); });
$('btn_new_appt')?.addEventListener('click',()=> { refreshRefs(); $('sheet_appt').classList.add('open'); });

/* ======= BACKUP / RESTORE ======= */
$('btn_backup').addEventListener('click', ()=>{
  const payload={exportedAt:new Date().toISOString(), version:'v1.4', profile:CURRENT, data:{medici,farmacie,visite,appuntamenti}};
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  a.download='biotos_crm_'+slug(CURRENT)+'_backup.json'; a.click();
});
$('inp_restore').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=async()=>{ try{ const j=JSON.parse(rd.result);
    medici=j.data?.medici||[]; farmacie=j.data?.farmacie||[]; visite=j.data?.visite||[]; appuntamenti=j.data?.appuntamenti||[]; await saveAll(); renderAll(); showToast('Backup importato');
  }catch(_){ alert('File non valido'); } }; rd.readAsText(f);
});

/* ======= PROFILO: EXPORT/IMPORT ======= */
$('btn_exp_profile').addEventListener('click', ()=>{
  const payload={profile:CURRENT, exportedAt:new Date().toISOString(), data:{medici,farmacie,visite,appuntamenti}};
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  a.download='profilo_'+slug(CURRENT)+'.json'; a.click();
});
$('inp_imp_profile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=async()=>{ try{ const j=JSON.parse(rd.result);
    medici=j.data?.medici||[]; farmacie=j.data?.farmacie||[]; visite=j.data?.visite||[]; appuntamenti=j.data?.appuntamenti||[]; await saveAll(); renderAll(); showToast('Profilo importato');
  }catch(_){ alert('File non valido'); } }; rd.readAsText(f);
});

/* ======= SEARCH ======= */
$('gsearch').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const q=e.target.value.trim();
    if(q.startsWith('#visite')){ openTab('visite'); $('v_q_from').value=''; $('v_q_to').value=''; $('v_q_tipo').value=''; }
    else { openTab('medici'); $('m_q').value=q; }
    renderAll();
  }
});

/* ======= HELPERS ======= */
function tagsStrToArr(s){ return (s||'').split(',').map(x=>x.trim()).filter(Boolean); }
function arrHasAllTags(list, tags){ if(tags.length===0) return true; const set=new Set((list||[]).map(x=>x.toLowerCase())); return tags.every(t=>set.has(t.toLowerCase())); }
function collectTopTags(items, field){ const map=new Map(); items.forEach(it=> (it[field]||[]).forEach(t=> map.set(t,(map.get(t)||0)+1))); return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,12).map(x=>x[0]); }
function chips(containerId, tags, activeSet, onToggle){
  const el=$(containerId); el.innerHTML=''; tags.forEach(t=>{ const b=document.createElement('button'); b.className='chip'+(activeSet.has(t)?' on':''); b.textContent=t; b.addEventListener('click', ()=>onToggle(t)); el.appendChild(b); });
}
function refreshRefs(){
  const vref=$('v_ref'), aref=$('a_ref'); vref.innerHTML=''; aref.innerHTML='';
  medici.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=`Dr. ${m.cognome||''} ${m.nome||''}`; vref.appendChild(o); });
  farmacie.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.ragione; vref.appendChild(o); });
  medici.concat(farmacie).forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.textContent=x.ragione?x.ragione:(x.cognome+' '+x.nome); aref.appendChild(o); });
}
function addDays(iso,d){ const x=new Date(iso||tISO()); x.setDate(x.getDate()+d); return tISO(x); }
function postponeFU(id,days){ const v=visite.find(x=>x.id===id); if(!v) return; v.follow = addDays(v.follow||tISO(), days); saveAll(); renderAll(); }
function quickVisit(ref,tipo){ $('sheet_visita').classList.add('open'); $('v_tipo').value=tipo; refreshRefs(); $('v_ref').value=ref; $('v_data').value=tISO(); }
function apptToVisit(id){ const a=appuntamenti.find(x=>x.id===id); if(!a) return; $('sheet_visita').classList.add('open'); $('v_data').value=a.data; $('v_tipo').value=a.tipo; refreshRefs(); $('v_ref').value=a.ref||''; $('v_next').value='Dopo appuntamento'; }

/* ======= RENDER ======= */
let M_TAGS = new Set(), F_TAGS = new Set(), V_TAGS = new Set();
function renderAll(){
  $('k_medici').value=medici.length;
  $('k_farmacie').value=farmacie.length;
  $('k_visite').value=visite.length;
  $('k_appt').value=appuntamenti.filter(a=>a.data>=tISO()).length;

  $('cards_dash').innerHTML = appuntamenti
    .slice().sort((a,b)=> (a.data+a.ora).localeCompare(b.data+b.ora)).slice(0,8)
    .map(a=>`<div class="card"><div class="main"><div class="title">${a.data} ${a.ora||''} • ${a.tit}</div><div class="meta">${a.tipo}${a.ref?(' – ref:'+a.ref):''}</div></div><button class="btn" onclick="apptToVisit('${a.id}')">→ Visita</button></div>`).join('');

  const mTop=collectTopTags(medici,'tag'), fTop=collectTopTags(farmacie,'tag'), vTop=collectTopTags(visite,'tag');
  chips('m_chips', mTop, M_TAGS, t=>{ if(M_TAGS.has(t)) M_TAGS.delete(t); else M_TAGS.add(t); renderAll(); });
  chips('f_chips', fTop, F_TAGS, t=>{ if(F_TAGS.has(t)) F_TAGS.delete(t); else F_TAGS.add(t); renderAll(); });
  chips('v_chips', vTop, V_TAGS, t=>{ if(V_TAGS.has(t)) V_TAGS.delete(t); else V_TAGS.add(t); renderAll(); });

  const mq=$('m_q').value?.toLowerCase()||'', mc=$('m_q_comune').value?.toLowerCase()||'', ms=$('m_q_spec').value||'';
  const mtags = tagsStrToArr($('m_q_tag').value); mtags.forEach(t=>M_TAGS.add(t));
  $('cards_medici').innerHTML = medici
    .filter(m=>(!mq || (`${m.nome} ${m.cognome}`).toLowerCase().includes(mq)) && (!mc || (m.comune||'').toLowerCase().includes(mc)) && (!ms || m.spec===ms) && arrHasAllTags(m.tag, Array.from(M_TAGS)))
    .map(m=>`<div class="card"><div class="main">
      <div class="title">${m.tit||'Dott.'} ${m.cognome||''} ${m.nome||''} • <span class="meta">${m.spec||''}</span></div>
      <div class="meta">${m.strutt||''} — ${m.comune||''}</div>
      <div class="meta">${(m.tag||[]).join(', ')}</div>
    </div>
    <div><button class="btn" onclick="quickVisit('${m.id}','Medico')">+ Visita</button></div></div>`).join('');

  const fq=$('f_q').value?.toLowerCase()||'', fc=$('f_q_comune').value?.toLowerCase()||'', ftags=tagsStrToArr($('f_q_tag').value); ftags.forEach(t=>F_TAGS.add(t));
  $('cards_farmacie').innerHTML = farmacie
    .filter(f=>(!fq || (f.ragione||'').toLowerCase().includes(fq)) && (!fc || (f.comune||'').toLowerCase().includes(fc)) && arrHasAllTags(f.tag, Array.from(F_TAGS)))
    .map(f=>`<div class="card"><div class="main">
      <div class="title">${f.ragione}</div>
      <div class="meta">${f.comune||''} — ${f.dir||''}</div>
      <div class="meta">${(f.tag||[]).join(', ')}</div>
    </div><div><button class="btn" onclick="quickVisit('${f.id}','Farmacia')">+ Visita</button></div></div>`).join('');

  const vf=$('v_q_from').value, vt=$('v_q_to').value, vtipo=$('v_q_tipo').value, vtags=tagsStrToArr($('v_q_tag').value); vtags.forEach(t=>V_TAGS.add(t));
  $('cards_visite').innerHTML = visite
    .filter(v=>(!vf || v.data>=vf) && (!vt || v.data<=vt) && (!vtipo || v.tipo===vtipo) && arrHasAllTags(v.tag, Array.from(V_TAGS)))
    .slice().sort((a,b)=> (b.data).localeCompare(a.data))
    .map(v=>`<div class="card"><div class="main"><div class="title">${v.data} • ${v.tipo} • ${v.prod||'—'}</div>
      <div class="meta">${v.esito||''} • ref:${v.ref||''} • FU:${v.follow||'-'} • FV/FL:${v.fv||0}/${v.fl||0}</div>
      <div class="meta">${(v.tag||[]).join(', ')}</div></div>
      <div><button class="btn" onclick="postponeFU('${v.id}',1)">+1</button>
           <button class="btn" onclick="postponeFU('${v.id}',3)">+3</button>
           <button class="btn" onclick="postponeFU('${v.id}',7)">+7</button>
           ${v.follow?`<button class="btn" onclick="createFUAppt('${v.id}')">FU → Appt</button>`:''}
      </div></div>`).join('');

  const af=$('a_from').value, at=$('a_to').value;
  $('cards_agenda').innerHTML = appuntamenti
    .filter(a=>(!af || a.data>=af)&&(!at || a.data<=at))
    .slice().sort((a,b)=> (a.data+a.ora).localeCompare(b.data+b.ora))
    .map(a=>`<div class="card"><div class="main"><div class="title">${a.data} ${a.ora||''} • ${a.tit}</div><div class="meta">${a.tipo}${a.ref?(' • ref:'+a.ref):''}</div></div><button class="btn" onclick="apptToVisit('${a.id}')">→ Visita</button></div>`).join('');

  const st=$('fu_state').value; const now=tISO(); const soon=tISO(new Date(Date.now()+3*86400000));
  const listFU = visite.filter(v=>v.follow);
  const list2 = listFU.filter(v=> st==='all' || (st==='over' && v.follow<now) || (st==='soon' && v.follow>=now && v.follow<=soon) || (st==='future' && v.follow>soon));
  $('cards_follow').innerHTML = list2.map(v=>`<div class="card"><div class="main"><div class="title">${v.follow} • ${v.tipo}</div><div class="meta">ref:${v.ref||''} • next:${v.next||'-'}</div></div>
  <div><button class="btn" onclick="postponeFU('${v.id}',1)">+1</button><button class="btn" onclick="postponeFU('${v.id}',3)">+3</button><button class="btn" onclick="postponeFU('${v.id}',7)">+7</button><button class="btn" onclick="createFUAppt('${v.id}')">FU → Appt</button></div></div>`).join('');

  const month=$('r_month').value || tISO().slice(0,7);
  const refe=$('r_refe').value;
  const inMonth = visite.filter(v=>v.data.startsWith(month) && (!refe || v.refe===refe));
  $('rk_visite').value = inMonth.length;
  $('rk_nuovi').value = inMonth.filter(v=>v.esito==='Nuovo contatto').length;
  $('rk_fu').value = inMonth.filter(v=>v.follow).length;
  const sumFV=inMonth.reduce((s,v)=>s+(+v.fv||0),0), sumFL=inMonth.reduce((s,v)=>s+(+v.fl||0),0);
  $('rk_ord').value = sumFV+'/'+sumFL;
  $('cards_rep').innerHTML = inMonth.map(v=>`<div class="card"><div class="main"><div class="title">${v.data} • ${v.tipo} ${v.prod||''}</div><div class="meta">${v.esito||''} • FV/FL:${v.fv||0}/${v.fl||0} • tag:${(v.tag||[]).join(',')}</div></div></div>`).join('');
}

function createFUAppt(vid){
  const v=visite.find(x=>x.id===vid); if(!v||!v.follow) return;
  $('sheet_appt').classList.add('open');
  $('a_data').value = v.follow;
  $('a_tit').value = 'Follow-up '+(v.tipo||'');
  $('a_tipo').value = v.tipo||'Medico';
  refreshRefs(); $('a_ref').value = v.ref||'';
}

/* ======= SAVE HANDLERS ======= */
$('btn_save_medico').addEventListener('click', async ()=>{
  const nome=($('m_nome').value||'').trim(), cognome=($('m_cognome').value||'').trim();
  if(!nome||!cognome){ return alert('Nome e Cognome obbligatori'); }
  medici.unshift({ id:uid(), tit:$('m_tit').value, nome, cognome, spec:$('m_spec').value, strutt:($('m_strutt').value||'').trim(), comune:($('m_comune').value||'').trim(), tel:($('m_tel').value||'').trim(), email:($('m_email').value||'').trim(), tag:tagsStrToArr($('m_tag').value), note:($('m_note').value||'').trim() });
  await saveAll(); renderAll(); $('sheet_medico').classList.remove('open'); showToast('Medico salvato');
});
$('btn_save_farmacia').addEventListener('click', async ()=>{
  const ragione=($('f_ragione').value||'').trim(); if(!ragione){ return alert('Ragione sociale obbligatoria'); }
  farmacie.unshift({ id:uid(), ragione, dir:($('f_dir').value||'').trim(), comune:($('f_comune').value||'').trim(), tel:($('f_tel').value||'').trim(), email:($('f_email').value||'').trim(), tag:tagsStrToArr($('f_tag').value), addr:($('f_addr').value||'').trim(), note:($('f_note').value||'').trim() });
  await saveAll(); renderAll(); $('sheet_farmacia').classList.remove('open'); showToast('Farmacia salvata');
});
$('btn_save_visita').addEventListener('click', async ()=>{
  const data=$('v_data').value||tISO(), tipo=$('v_tipo').value, ref=$('v_ref').value||'';
  if(!data||!tipo||!ref){ return alert('Data, Tipo e Riferimento sono obbligatori'); }
  visite.unshift({ id:uid(), data, tipo, ref, prod:$('v_prod').value, esito:$('v_esito').value, refe:$('v_refe').value, mat:($('v_mat').value||'').trim(), next:($('v_next').value||'').trim(), follow:$('v_follow').value||'', fv:+($('v_fv').value||0), fl:+($('v_fl').value||0), tag:tagsStrToArr($('v_tag').value), note:($('v_note').value||'').trim() });
  await saveAll(); renderAll(); $('sheet_visita').classList.remove('open'); showToast('Visita salvata');
});
$('btn_save_appt').addEventListener('click', async ()=>{
  const data=$('a_data').value||tISO(), ora=$('a_ora').value||'', tit=($('a_tit').value||'Appuntamento').trim();
  if(!data||!tit){ return alert('Data e Titolo obbligatori'); }
  appuntamenti.unshift({id:uid(), data, ora, tit, tipo:$('a_tipo').value, ref:$('a_ref').value||'', note:($('a_note').value||'').trim()});
  await saveAll(); renderAll(); $('sheet_appt').classList.remove('open'); showToast('Appuntamento salvato');
});

/* ======= CSV ======= */
function toCSV(arr, headers){
  const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
  const lines=[headers.join(',')];
  arr.forEach(o=> lines.push(headers.map(h=> esc(Array.isArray(o[h])? o[h].join(', ') : o[h])).join(',')));
  return lines.join('\r\n');
}
function fromCSV(text){
  const lines=text.split(/\r?\n/).filter(Boolean);
  const hdr=lines.shift().split(',');
  const rows=lines.map(line=>{
    const out=[]; let cur='', q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch=='"'){ if(q && line[i+1]=='"'){ cur+='"'; i++; } else { q=!q; } }
      else if(ch==',' && !q){ out.push(cur); cur=''; }
      else cur+=ch;
    }
    out.push(cur);
    const obj={}; hdr.forEach((h,idx)=> obj[h]=out[idx]||'' ); return obj;
  });
  return {headers:hdr, rows};
}
$('btn_exp_med').addEventListener('click', ()=>{
  const csv = toCSV(medici, ['id','tit','nome','cognome','spec','strutt','comune','tel','email','tag','note']);
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='medici_'+slug(CURRENT)+'.csv'; a.click();
});
$('inp_imp_med').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=async()=>{
    const {rows}=fromCSV(rd.result); rows.forEach(r=>{ r.tag = (r.tag? r.tag.split(',').map(s=>s.trim()).filter(Boolean):[]); });
    medici = rows.map(r=>Object.assign({id:uid()}, r));
    await saveAll(); renderAll(); showToast('Medici importati');
  }; rd.readAsText(f);
});
$('btn_exp_far').addEventListener('click', ()=>{
  const csv = toCSV(farmacie, ['id','ragione','dir','comune','tel','email','tag','addr','note']);
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='farmacie_'+slug(CURRENT)+'.csv'; a.click();
});
$('inp_imp_far').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=async()=>{
    const {rows}=fromCSV(rd.result); rows.forEach(r=>{ r.tag = (r.tag? r.tag.split(',').map(s=>s.trim()).filter(Boolean):[]); });
    farmacie = rows.map(r=>Object.assign({id:uid()}, r));
    await saveAll(); renderAll(); showToast('Farmacie importate');
  }; rd.readAsText(f);
});
$('btn_exp_vis').addEventListener('click', ()=>{
  const csv = toCSV(visite, ['id','data','tipo','ref','prod','esito','refe','mat','next','follow','fv','fl','tag','note']);
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='visite_'+slug(CURRENT)+'.csv'; a.click();
});
$('inp_imp_vis').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=async()=>{
    const {rows}=fromCSV(rd.result); rows.forEach(r=>{ r.fv=+r.fv||0; r.fl=+r.fl||0; r.tag = (r.tag? r.tag.split(',').map(s=>s.trim()).filter(Boolean):[]); });
    visite = rows.map(r=>Object.assign({id:uid()}, r));
    await saveAll(); renderAll(); showToast('Visite importate');
  }; rd.readAsText(f);
});

/* ======= ICS EXPORT ======= */
$('btn_exp_ics').addEventListener('click', ()=>{
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Biotos CRM//FollowUp//IT'];
  visite.filter(v=>v.follow).forEach(v=>{
    const dt=v.follow.replace(/-/g,'')+'T090000';
    lines.push('BEGIN:VEVENT','UID:'+v.id+'@biotos','DTSTAMP:'+dt,'DTSTART:'+dt,'SUMMARY:Follow-up '+v.tipo,'DESCRIPTION:ref '+(v.ref||''),'END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([lines.join('\r\n')],{type:'text/calendar'})); a.download='followup_'+slug(CURRENT)+'.ics'; a.click();
});

/* ======= FILTERS BINDINGS ======= */
['m_q','m_q_comune','m_q_spec','m_q_tag','f_q','f_q_comune','f_q_tag','v_q_from','v_q_to','v_q_tipo','v_q_tag','a_from','a_to','fu_state','r_month','r_refe']
  .forEach(id=> $(id)?.addEventListener('input', renderAll));

/* ======= ONBOARDING ======= */
$('ok_onb').addEventListener('click',()=>{
  if($('dontshow').checked){ localStorage.setItem('biotos:onboard','1'); }
  $('onboarding').classList.remove('show');
});

/* ======= BOOT ======= */
async function boot(profileSwitch=false){
  ensureProfileListUI();
  await loadAll();
  renderAll();
  if(!localStorage.getItem('biotos:onboard')){ $('onboarding').classList.add('show'); }
  if(!profileSwitch) openTab('dashboard');
}
boot();
</script>
</body>
</html>
