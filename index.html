<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no, email=no, address=no">
  <title>Biotos CRM – v1.1</title>
  <meta name="theme-color" content="#0b8f5c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Biotos CRM">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#07130e; --panel:#0c2319; --panel2:#0a1c15; --muted:#cfeadd; --text:#f6fffa;
      --accent:#0b8f5c; --accent-2:#10b97a; --line:#1a563b; --danger:#ff6b6b; --warn:#ffc857; --ok:#28d07e;
      --nav-h:48px;
    }
    [data-theme="light"]{
      --bg:#f7fbf8; --panel:#ffffff; --panel2:#f2f7f4; --muted:#3b5b4b; --text:#0b2017; --line:#d7e8df;
      --accent:#0b8f5c; --accent-2:#087e52;
    }
    [data-theme="hc"]{
      --bg:#000; --panel:#000; --panel2:#000; --muted:#bfe6d5; --text:#fff; --line:#3ddc97; --accent:#3ddc97; --accent-2:#93f9b9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.55 -apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;background:var(--bg);z-index:50;padding-top:calc(2px + env(safe-area-inset-top));border-bottom:1px solid rgba(23,86,59,.35);backdrop-filter:saturate(1.2) blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:4px 12px}
    h1{font-size:16px;margin:0;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
    h1 img{width:22px;height:22px;border-radius:6px;border:1px solid var(--line);background:#fff}
    .savebadge{margin-left:auto;font-size:11px;color:#bfe5cf}
    .globalsearch{margin:4px 0 2px;display:flex;gap:8px}
    .globalsearch input{flex:1;background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-height:40px;color:var(--text)}
    .gsres{position:absolute;background:var(--panel);border:1px solid var(--line);border-radius:12px;margin-top:4px;z-index:60;display:none;max-height:50vh;overflow:auto}
    .bottomnav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--line);
      display:flex;gap:6px;padding:4px env(safe-area-inset-right) calc(4px + env(safe-area-inset-bottom)) env(safe-area-inset-left);z-index:45;height:var(--nav-h);
      overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x proximity; scrollbar-width:none}
    .bottomnav::-webkit-scrollbar{display:none}
    .bottomnav:before,.bottomnav:after{content:'';position:sticky;top:0;bottom:0;width:18px;pointer-events:none}
    .bottomnav:before{left:0;background:linear-gradient(90deg,var(--bg),transparent)}
    .bottomnav:after{right:0;background:linear-gradient(-90deg,var(--bg),transparent)}
    .bottomnav button{flex:0 0 auto;min-width:84px;border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:6px 8px;border-radius:10px;min-height:34px;font-size:13px;
      display:flex;gap:6px;align-items:center;justify-content:center;scroll-snap-align:center}
    .bottomnav button .ico{font-size:16px}
    .bottomnav button.active{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 16%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 35%, transparent)}
    @media (max-width:430px){ .bottomnav button span.label{display:none} .bottomnav button{min-width:52px} }
    .topnav{display:none;gap:8px;margin-top:4px}
    .topnav button{border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:8px 10px;border-radius:10px;min-height:36px;font-size:14px}
    .topnav button.active{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 16%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 35%, transparent)}
    .grid{display:grid;gap:10px;contain:paint}
    .pan{background:var(--panel);padding:10px;border-radius:14px;border:1px solid var(--line)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 280px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--line);border-radius:12px;padding:12px;min-height:42px;font-size:16px}
    input:invalid,select:invalid,textarea:invalid{border-color:var(--danger); box-shadow:0 0 0 1px #ff8a8a22 inset}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#103024;color:var(--text);padding:9px 11px;border-radius:12px;cursor:pointer;min-height:38px;font-size:15px;-webkit-tap-highlight-color:transparent}
    .btn.primary{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 18%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 40%, transparent)}
    .btn.block{width:100%;justify-content:center}
    .btn.ghost{background:transparent}
    .pill{display:inline-block;padding:3px 9px;border-radius:999px;border:1px solid var(--line);background:color-mix(in oklab, var(--accent) 12%, var(--panel2));color:#e9fff6}
    [data-theme="light"] .pill{background:#e6f4ef;color:#0b5c3f;border-color:#b8dfcd}
    .muted{color:var(--muted)} .right{margin-left:auto} .hidden{display:none!important}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:color-mix(in oklab, var(--accent) 10%, var(--panel2));color:#e9fff6}
    [data-theme="light"] .chip{background:#e8f5f0;color:#0b5c3f;border-color:#c7e7d8}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .kpis .pan{padding:10px} .kpis h3{margin:4px 0 2px;font-size:12px;color:#cfe8dc} .kpis .value{font-size:22px;font-weight:800}
    .tablewrap{max-height:60vh;overflow:auto;border:1px solid var(--line);border-radius:12px;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);text-align:left;padding:10px 8px}
    tbody td{padding:10px 8px;border-bottom:1px solid var(--line);vertical-align:top}
    tbody tr:nth-child(2n){background:color-mix(in oklab, var(--panel) 86%, black)}
    [data-theme="light"] tbody tr:nth-child(2n){background:#f6fbf8}
    .cards{display:grid;gap:8px;contain:paint}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;gap:10px;align-items:flex-start}
    .card .main{flex:1;min-width:0}
    .card .title{font-weight:800; letter-spacing:.2px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .card .subtitle{color:#d6eee4; font-size:13px;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    [data-theme="light"] .card .subtitle{color:#4b6a5a}
    .card .meta{font-size:13px;color:#b7c7bf;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    [data-theme="light"] .card .meta{color:#577868}
    .fab{position:fixed;right:16px;bottom:calc(var(--nav-h) + 18px + env(safe-area-inset-bottom));width:54px;height:54px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;background:var(--accent);color:#07170f;font-weight:800;border:0;z-index:44;box-shadow:0 10px 26px rgba(0,0,0,.45)}
    .fabmenu{position:fixed;right:16px;bottom:calc(var(--nav-h) + 82px + env(safe-area-inset-bottom));display:none;flex-direction:column;gap:8px;z-index:46}
    .fabmenu .btn{background:color-mix(in oklab, var(--accent) 14%, #0f2e22);border-color:var(--accent)}
    .fabmenu.show{display:flex}
    .sheet{position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);z-index:60}
    .sheet.open{display:block}
    .sheet .panel{position:absolute;left:0;right:0;bottom:0;background:#0c2219;border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      padding:10px 10px calc(12px + env(safe-area-inset-bottom));max-height:90vh;overflow:auto}
    [data-theme="light"] .sheet .panel{background:#ffffff}
    .sheet h3{margin:2px 4px 8px}
    .sheet .row>*{flex:1 1 240px}
    .sheet .close{position:absolute;right:10px;top:6px;background:transparent;border:0;color:#dfe; font-size:22px}
    [data-theme="light"] .sheet .close{color:#244136}
    details{background:#0b241a;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    [data-theme="light"] details{background:#f2f7f4}
    details>summary{cursor:pointer;font-weight:700}
    details[open]{box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 30%, transparent)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--nav-h) + 20px + env(safe-area-inset-bottom));background:#0f2e22;border:1px solid var(--line);padding:8px 12px;border-radius:12px;z-index:70;display:none}
    .toast.show{display:block}
    @media (min-width:900px){
      .bottomnav{display:none}
      .topnav{display:flex}
      .wrap{padding-bottom:20px}
      .cards{display:none}
      .tablewrap{display:block}
      .fab{right:24px; bottom:24px}
    }
    @media (max-width:899px){
      .wrap{padding-bottom:calc(var(--nav-h) + 52px)}
      .tablewrap{display:none}
      .cards{display:grid}
    }
    button{border:0}
    button.btn, .tabbtn{user-select:none}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><img src="icons/icon-192.png" alt="logo"> Biotos CRM <span class="muted">v1.1</span>
      <span class="savebadge" id="savebadge">Salvato ✓</span>
      <span style="margin-left:8px"><select id="themeSel">
        <option value="auto">Auto</option><option value="dark">Scuro</option><option value="light">Chiaro</option><option value="hc">Contrasto alto</option>
      </select></span>
      <span class="right muted" id="accountBadge">—</span>
    </h1>
    <div class="globalsearch">
      <input id="gsearch" placeholder="Cerca in medici, farmacie, visite, appuntamenti…" autocapitalize="words" autocomplete="off">
      <div class="gsres" id="gsres"></div>
    </div>
    <div class="topnav" id="topnav">
      <button type="button" class="tabbtn active" data-tab="dashboard">🏠 Dashboard</button>
      <button type="button" class="tabbtn" data-tab="medici">👩‍⚕️ Medici</button>
      <button type="button" class="tabbtn" data-tab="farmacie">💊 Farmacie</button>
      <button type="button" class="tabbtn" data-tab="visite">📝 Visite</button>
      <button type="button" class="tabbtn" data-tab="agenda">🗓️ Agenda</button>
      <button type="button" class="tabbtn" data-tab="followup">⏰ Follow-up</button>
      <button type="button" class="tabbtn" data-tab="report">📈 Report</button>
      <button type="button" class="tabbtn" data-tab="io">⚙️ Dati</button>
    </div>
  </div>
</header>

<main class="wrap" id="mainwrap">
  <section id="dashboard" class="grid">
    <div class="kpis">
      <div class="pan"><h3>Medici schedati</h3><div class="value stat" id="k_medici">0</div></div>
      <div class="pan"><h3>Farmacie schedate</h3><div class="value stat" id="k_farmacie">0</div></div>
      <div class="pan"><h3>Visite totali</h3><div class="value stat" id="k_visite">0</div></div>
      <div class="pan"><h3>Appuntamenti futuri</h3><div class="value stat" id="k_appt">0</div></div>
      <div class="pan"><h3>Follow-up scaduti</h3><div class="value stat" id="k_fu_over">0</div></div>
      <div class="pan"><h3>Follow-up prossimi 3 gg</h3><div class="value stat" id="k_fu_soon">0</div></div>
    </div>
    <div class="pan">
      <h3 style="margin:0 0 6px">Oggi e prossimi</h3>
      <div class="cards" id="cards_dash"></div>
    </div>
  </section>

  <section id="medici" class="grid hidden">
    <div class="pan">
      <div class="row"><div class="right">
        <button type="button" class="btn" id="btn_new_med">+ Medico</button>
      </div></div>
      <div class="cards" id="cards_medici"></div>
    </div>
  </section>

  <section id="farmacie" class="grid hidden">
    <div class="pan">
      <div class="row"><div class="right">
        <button type="button" class="btn" id="btn_new_far">+ Farmacia</button>
      </div></div>
      <div class="cards" id="cards_farmacie"></div>
    </div>
  </section>

  <section id="visite" class="grid hidden">
    <div class="pan">
      <div class="row"><div class="right">
        <button type="button" class="btn" id="btn_new_vis">+ Visita</button>
      </div></div>
      <div class="cards" id="cards_visite"></div>
      <div class="right muted" id="info_visite"></div>
    </div>
  </section>

  <section id="agenda" class="grid hidden">
    <div class="pan">
      <div class="row"><div class="right">
        <button type="button" class="btn" id="btn_new_appt">+ Appuntamento</button>
      </div></div>
      <div class="cards" id="cards_agenda"></div>
    </div>
  </section>

  <section id="followup" class="grid hidden">
    <div class="pan">
      <div class="cards" id="cards_follow"></div>
    </div>
  </section>

  <section id="report" class="grid hidden">
    <div class="pan">
      <div class="cards" id="cards_rep"></div>
    </div>
  </section>

  <section id="io" class="grid hidden">
    <div class="pan">
      <h3 style="margin:0 0 8px">Backup & Dati</h3>
      <div class="row">
        <button type="button" class="btn" id="btn_exp_json">⬇️ Esporta backup JSON</button>
        <input type="file" id="inp_imp_json" accept="application/json" class="btn">
        <button type="button" class="btn" id="btn_clear" title="Cancella tutti i dati (profilo/account corrente)">🗑️ Reset dati</button>
      </div>
      <p class="muted">I dati restano sul dispositivo (LocalStorage). Uso attuale: <span id="stor_usage">–</span></p>
    </div>
  </section>
</main>

<nav class="bottomnav" id="bottomnav" aria-label="Sezioni principali">
  <button type="button" class="tabbtn active" data-tab="dashboard" aria-label="Dashboard"><span class="ico">🏠</span><span class="label">Home</span></button>
  <button type="button" class="tabbtn" data-tab="medici" aria-label="Medici"><span class="ico">👩‍⚕️</span><span class="label">Medici</span></button>
  <button type="button" class="tabbtn" data-tab="farmacie" aria-label="Farmacie"><span class="ico">💊</span><span class="label">Farmacie</span></button>
  <button type="button" class="tabbtn" data-tab="visite" aria-label="Visite"><span class="ico">📝</span><span class="label">Visite</span></button>
  <button type="button" class="tabbtn" data-tab="agenda" aria-label="Agenda"><span class="ico">🗓️</span><span class="label">Agenda</span></button>
  <button type="button" class="tabbtn" data-tab="followup" aria-label="Follow-up"><span class="ico">⏰</span><span class="label">F/U</span></button>
  <button type="button" class="tabbtn" data-tab="report" aria-label="Report"><span class="ico">📈</span><span class="label">Report</span></button>
  <button type="button" class="tabbtn" data-tab="io" aria-label="Dati e impostazioni"><span class="ico">⚙️</span><span class="label">Dati</span></button>
</nav>

<button class="fab" id="fab" title="Azioni" aria-label="Azioni">＋</button>
<div class="fabmenu" id="fabmenu" aria-label="Azioni rapide">
  <button type="button" class="btn" id="act_new_med">+ Medico</button>
  <button type="button" class="btn" id="act_new_far">+ Farmacia</button>
  <button type="button" class="btn" id="act_new_vis">+ Visita</button>
  <button type="button" class="btn" id="act_new_appt2">+ Appuntamento</button>
</div>

<div class="toast" id="toast"></div>

<!-- SHEETS minime per garantire aggiunta -->
<div class="sheet" id="sheet_medico"><div class="panel">
  <button class="close" data-close="sheet_medico">✕</button><h3>Nuovo medico</h3>
  <div class="row"><div><label>Nome</label><input id="m_nome"></div><div><label>Cognome</label><input id="m_cognome"></div></div>
  <div class="row"><div><label>Comune</label><input id="m_comune"></div></div>
  <div class="row"><button id="btn_save_medico" class="btn primary block" type="button">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_farmacia"><div class="panel">
  <button class="close" data-close="sheet_farmacia">✕</button><h3>Nuova farmacia</h3>
  <div class="row"><div><label>Ragione sociale</label><input id="f_ragione"></div><div><label>Comune</label><input id="f_comune"></div></div>
  <div class="row"><button id="btn_save_farmacia" class="btn primary block" type="button">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_visita"><div class="panel">
  <button class="close" data-close="sheet_visita">✕</button><h3>Nuova visita</h3>
  <div class="row"><div><label>Data</label><input id="v_data" type="date"></div>
  <div><label>Tipo</label><select id="v_tipo"><option>Medico</option><option>Farmacia</option></select></div>
  <div><label>Rif.</label><select id="v_ref"></select></div></div>
  <div class="row"><div><label>Esito</label><select id="v_esito"><option>Incontro svolto</option><option>Nuovo contatto</option></select></div>
  <div><label>Follow-up</label><input id="v_follow" type="date"></div></div>
  <div class="row"><button id="btn_save_visita" class="btn primary block" type="button">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_appt"><div class="panel">
  <button class="close" data-close="sheet_appt">✕</button><h3>Nuovo appuntamento</h3>
  <div class="row"><div><label>Data</label><input id="a_data" type="date"></div><div><label>Ora</label><input id="a_ora" type="time"></div></div>
  <div class="row"><div><label>Titolo</label><input id="a_tit"></div></div>
  <div class="row"><button id="btn_save_appt" class="btn primary block" type="button">Salva</button></div>
</div></div>

<script>
const $=id=>document.getElementById(id);
function todayISO(){return new Date().toISOString().slice(0,10)}
function uid(){return 'id_'+Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4)}
function dl(fn,text){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'}));a.download=fn;a.click();}
function toast(t){ const el=$('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500); }

// CACHE SW
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

// DATA
let medici=[], farmacie=[], visite=[], appuntamenti=[];
const K=(key)=> 'guest:Default:'+key;
function save(){ localStorage.setItem(K('data'), JSON.stringify({medici,farmacie,visite,appuntamenti})); updateSize(); }
function load(){ try{ const j=JSON.parse(localStorage.getItem(K('data'))||'{}'); medici=j.medici||[]; farmacie=j.farmacie||[]; visite=j.visite||[]; appuntamenti=j.appuntamenti||[]; }catch(_){ } }
function updateSize(){ try{ const sz=(JSON.stringify({medici,farmacie,visite,appuntamenti}).length||0); const el=$('stor_usage'); if(el) el.textContent=(sz/1024).toFixed(1)+' KB'; }catch(_){} }

// NAV
function openTab(tab){
  document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tabbtn[data-tab="'+tab+'"]').forEach(x=>x.classList.add('active'));
  document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
  const sec=document.getElementById(tab); if(sec) sec.classList.remove('hidden');
  window.scrollTo({top:0, behavior:'smooth'});
}
document.addEventListener('click', (e)=>{
  const t = e.target.closest('.tabbtn'); if(t){ e.preventDefault(); openTab(t.dataset.tab); }
});

// CLOSE SHEETS
document.querySelectorAll('.sheet .close').forEach(b=>b.addEventListener('click',()=> b.closest('.sheet').classList.remove('open')));

// FAB
const fab=$('fab'), fabmenu=$('fabmenu');
fab.addEventListener('click', ()=> fabmenu.classList.toggle('show'));
document.addEventListener('click', e=>{ if(!fab.contains(e.target) && !fabmenu.contains(e.target)) fabmenu.classList.remove('show'); });

// Actions
$('btn_new_med').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); $('sheet_medico').classList.add('open'); });
$('btn_new_far').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); $('sheet_farmacia').classList.add('open'); });
$('btn_new_vis').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); refreshVisitRefs(); $('sheet_visita').classList.add('open'); });
$('btn_new_appt').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); $('sheet_appt').classList.add('open'); });
$('act_new_med').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); $('sheet_medico').classList.add('open'); });
$('act_new_far').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); $('sheet_farmacia').classList.add('open'); });
$('act_new_vis').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); refreshVisitRefs(); $('sheet_visita').classList.add('open'); });
$('act_new_appt2').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); $('sheet_appt').classList.add('open'); });

function refreshVisitRefs(){
  const sel=$('v_ref'); sel.innerHTML='';
  const tipo = $('v_tipo').value;
  const list = (tipo==='Medico'? medici : farmacie);
  list.forEach(x=>{ const opt=document.createElement('option'); opt.value=x.id; opt.textContent = tipo==='Medico' ? (x.nome+' '+x.cognome) : (x.ragione||''); sel.appendChild(opt); });
}
$('v_tipo').addEventListener('change', refreshVisitRefs);

// SAVE handlers
$('btn_save_medico').addEventListener('click', ()=>{
  const nome=($('m_nome').value||'').trim(), cognome=($('m_cognome').value||'').trim(); if(!nome||!cognome){ alert('Nome e Cognome obbligatori'); return; }
  medici.unshift({id:uid(), nome, cognome, comune:($('m_comune').value||'').trim()});
  save(); renderAll(); $('sheet_medico').classList.remove('open'); toast('Medico salvato');
});
$('btn_save_farmacia').addEventListener('click', ()=>{
  const ragione=($('f_ragione').value||'').trim(); if(!ragione){ alert('Ragione sociale obbligatoria'); return; }
  farmacie.unshift({id:uid(), ragione, comune:($('f_comune').value||'').trim()});
  save(); renderAll(); $('sheet_farmacia').classList.remove('open'); toast('Farmacia salvata');
});
$('btn_save_visita').addEventListener('click', ()=>{
  const data=$('v_data').value || (new Date().toISOString().slice(0,10));
  const tipo=$('v_tipo').value; const ref=$('v_ref').value||''; const esito=$('v_esito').value||'Incontro svolto'; const follow=$('v_follow').value||'';
  visite.unshift({id:uid(), data, tipo, ref, esito, follow});
  save(); renderAll(); $('sheet_visita').classList.remove('open'); toast('Visita salvata');
});
$('btn_save_appt').addEventListener('click', ()=>{
  const data=$('a_data').value || (new Date().toISOString().slice(0,10));
  const ora=$('a_ora').value||''; const tit=($('a_tit').value||'Appuntamento').trim();
  appuntamenti.unshift({id:uid(), data, ora, tit, tipo:'Medico', ref:''});
  save(); renderAll(); $('sheet_appt').classList.remove('open'); toast('Appuntamento salvato');
});

// SIMPLE renders
function renderAll(){
  const cM=$('cards_medici'); cM.innerHTML = medici.map(m=>`<div class="card"><div class="main"><div class="title">${m.nome} ${m.cognome}</div><div class="meta">${m.comune||''}</div></div></div>`).join('');
  const cF=$('cards_farmacie'); cF.innerHTML = farmacie.map(f=>`<div class="card"><div class="main"><div class="title">${f.ragione}</div><div class="meta">${f.comune||''}</div></div></div>`).join('');
  const cV=$('cards_visite'); cV.innerHTML = visite.map(v=>`<div class="card"><div class="main"><div class="title">${v.data} • ${v.tipo}</div><div class="meta">${v.esito}${v.follow?(' • FU '+v.follow):''}</div></div></div>`).join('');
  const cA=$('cards_agenda'); cA.innerHTML = appuntamenti.map(a=>`<div class="card"><div class="main"><div class="title">${a.data}${a.ora?(' '+a.ora):''} • ${a.tit}</div></div></div>`).join('');
  // KPI
  document.getElementById('k_medici').textContent=medici.length;
  document.getElementById('k_farmacie').textContent=farmacie.length;
  document.getElementById('k_visite').textContent=visite.length;
  document.getElementById('k_appt').textContent=appuntamenti.filter(a=>a.data >= new Date().toISOString().slice(0,10)).length;
  updateSize();
}

// Export/Import JSON
$('btn_exp_json').addEventListener('click', ()=>{
  const payload = { exportedAt: new Date().toISOString(), version: 'v1.1', data:{medici,farmacie,visite,appuntamenti} };
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'})); a.download='biotos_crm_backup.json'; a.click();
});
$('inp_imp_json').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{const j=JSON.parse(rd.result); medici=j.data?.medici||[]; farmacie=j.data?.farmacie||[]; visite=j.data?.visite||[]; appuntamenti=j.data?.appuntamenti||[]; save(); renderAll(); alert('Backup importato');}catch(_){ alert('File non valido'); } }; rd.readAsText(f);
});
$('btn_clear').addEventListener('click', ()=>{ if(!confirm('Cancellare tutti i dati?')) return; medici=[]; farmacie=[]; visite=[]; appuntamenti=[]; save(); renderAll(); });

// START
load(); renderAll(); openTab('dashboard');
</script>
</body>
</html>
