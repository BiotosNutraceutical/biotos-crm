<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no, email=no, address=no">
  <title>Biotos CRM – v1.0</title>
  <meta name="theme-color" content="#0b8f5c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Biotos CRM">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#07130e; --panel:#0c2319; --panel2:#0a1c15; --muted:#cfeadd; --text:#f6fffa;
      --accent:#0b8f5c; --accent-2:#10b97a; --line:#1a563b; --danger:#ff6b6b; --warn:#ffc857; --ok:#28d07e;
      --nav-h:48px;
    }
    /* Palette chiara con contrasto migliorato (niente testo verde chiaro su bianco) */
    [data-theme="light"]{
      --bg:#f7fbf8; --panel:#ffffff; --panel2:#f2f7f4; --muted:#3b5b4b; --text:#0b2017; --line:#d7e8df;
      --accent:#0b8f5c; --accent-2:#087e52;
    }
    /* Modalità ad alto contrasto */
    [data-theme="hc"]{
      --bg:#000; --panel:#000; --panel2:#000; --muted:#bfe6d5; --text:#fff; --line:#3ddc97; --accent:#3ddc97; --accent-2:#93f9b9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.55 -apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;background:var(--bg);z-index:50;padding-top:calc(2px + env(safe-area-inset-top));border-bottom:1px solid rgba(23,86,59,.35);backdrop-filter:saturate(1.2) blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:4px 12px}
    h1{font-size:16px;margin:0;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
    h1 img{width:22px;height:22px;border-radius:6px;border:1px solid var(--line);background:#fff}
    .savebadge{margin-left:auto;font-size:11px;color:#bfe5cf}
    .globalsearch{margin:4px 0 2px;display:flex;gap:8px}
    .globalsearch input{flex:1;background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-height:40px;color:var(--text)}
    .gsres{position:absolute;background:var(--panel);border:1px solid var(--line);border-radius:12px;margin-top:4px;z-index:60;display:none;max-height:50vh;overflow:auto}
    /* BOTTOM NAV ottimizzata per smartphone con scroll orizzontale “drag” */
    .bottomnav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--line);
      display:flex;gap:6px;padding:4px env(safe-area-inset-right) calc(4px + env(safe-area-inset-bottom)) env(safe-area-inset-left);z-index:45;height:var(--nav-h);
      overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x proximity; scrollbar-width:none}
    .bottomnav::-webkit-scrollbar{display:none}
    .bottomnav:before,.bottomnav:after{content:'';position:sticky;top:0;bottom:0;width:18px;pointer-events:none}
    .bottomnav:before{left:0;background:linear-gradient(90deg,var(--bg),transparent)}
    .bottomnav:after{right:0;background:linear-gradient(-90deg,var(--bg),transparent)}
    .bottomnav button{flex:0 0 auto;min-width:84px;border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:6px 8px;border-radius:10px;min-height:34px;font-size:13px;
      display:flex;gap:6px;align-items:center;justify-content:center;scroll-snap-align:center}
    .bottomnav button .ico{font-size:16px}
    .bottomnav button.active{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 16%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 35%, transparent)}
    @media (max-width:430px){ .bottomnav button span.label{display:none} .bottomnav button{min-width:52px} } /* risolve overflow su iPhone 16 Pro */
    /* Top nav (desktop) */
    .topnav{display:none;gap:8px;margin-top:4px}
    .topnav button{border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:8px 10px;border-radius:10px;min-height:36px;font-size:14px}
    .topnav button.active{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 16%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 35%, transparent)}
    /* Layout */
    .grid{display:grid;gap:10px;contain:paint}
    .pan{background:var(--panel);padding:10px;border-radius:14px;border:1px solid var(--line)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 280px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--line);border-radius:12px;padding:12px;min-height:42px;font-size:16px}
    input:invalid,select:invalid,textarea:invalid{border-color:var(--danger); box-shadow:0 0 0 1px #ff8a8a22 inset}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#103024;color:var(--text);padding:9px 11px;border-radius:12px;cursor:pointer;min-height:38px;font-size:15px;-webkit-tap-highlight-color:transparent}
    .btn.primary{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 18%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 40%, transparent)}
    .btn.block{width:100%;justify-content:center}
    .btn.ghost{background:transparent}
    .pill{display:inline-block;padding:3px 9px;border-radius:999px;border:1px solid var(--line);background:color-mix(in oklab, var(--accent) 12%, var(--panel2));color:#e9fff6}
    [data-theme="light"] .pill{background:#e6f4ef;color:#0b5c3f;border-color:#b8dfcd}
    .muted{color:var(--muted)} .right{margin-left:auto} .hidden{display:none!important}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:color-mix(in oklab, var(--accent) 10%, var(--panel2));color:#e9fff6}
    [data-theme="light"] .chip{background:#e8f5f0;color:#0b5c3f;border-color:#c7e7d8}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .kpis .pan{padding:10px} .kpis h3{margin:4px 0 2px;font-size:12px;color:#cfe8dc} .kpis .value{font-size:22px;font-weight:800}
    .tablewrap{max-height:60vh;overflow:auto;border:1px solid var(--line);border-radius:12px;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);text-align:left;padding:10px 8px}
    tbody td{padding:10px 8px;border-bottom:1px solid var(--line);vertical-align:top}
    tbody tr:nth-child(2n){background:color-mix(in oklab, var(--panel) 86%, black)}
    [data-theme="light"] tbody tr:nth-child(2n){background:#f6fbf8}
    .cards{display:grid;gap:8px;contain:paint}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;gap:10px;align-items:flex-start}
    .card .main{flex:1;min-width:0}
    .card .title{font-weight:800; letter-spacing:.2px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .card .subtitle{color:#d6eee4; font-size:13px;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    [data-theme="light"] .card .subtitle{color:#4b6a5a}
    .card .meta{font-size:13px;color:#b7c7bf;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    [data-theme="light"] .card .meta{color:#577868}
    /* Floating Action Button e menu (ripuliti per evitare sovrapposizioni) */
    .fab{position:fixed;right:16px;bottom:calc(var(--nav-h) + 18px + env(safe-area-inset-bottom));width:54px;height:54px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;background:var(--accent);color:#07170f;font-weight:800;border:0;z-index:44;box-shadow:0 10px 26px rgba(0,0,0,.45)}
    .fabmenu{position:fixed;right:16px;bottom:calc(var(--nav-h) + 82px + env(safe-area-inset-bottom));display:none;flex-direction:column;gap:8px;z-index:46}
    .fabmenu .btn{background:color-mix(in oklab, var(--accent) 14%, #0f2e22);border-color:var(--accent)}
    .fabmenu.show{display:flex}
    .sheet{position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);z-index:60}
    .sheet.open{display:block}
    .sheet .panel{position:absolute;left:0;right:0;bottom:0;background:#0c2219;border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      padding:10px 10px calc(12px + env(safe-area-inset-bottom));max-height:90vh;overflow:auto}
    [data-theme="light"] .sheet .panel{background:#ffffff}
    .sheet h3{margin:2px 4px 8px}
    .sheet .row>*{flex:1 1 240px}
    .sheet .close{position:absolute;right:10px;top:6px;background:transparent;border:0;color:#dfe; font-size:22px}
    [data-theme="light"] .sheet .close{color:#244136}
    details{background:#0b241a;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    [data-theme="light"] details{background:#f2f7f4}
    details>summary{cursor:pointer;font-weight:700}
    details[open]{box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--accent) 30%, transparent)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--nav-h) + 20px + env(safe-area-inset-bottom));background:#0f2e22;border:1px solid var(--line);padding:8px 12px;border-radius:12px;z-index:70;display:none}
    .toast.show{display:block}
    @media (min-width:900px){
      .bottomnav{display:none}
      .topnav{display:flex}
      .wrap{padding-bottom:20px}
      .cards{display:none}
      .tablewrap{display:block}
      .fab{right:24px; bottom:24px}
    }
    @media (max-width:899px){
      .wrap{padding-bottom:calc(var(--nav-h) + 52px)}
      .tablewrap{display:none}
      .cards{display:grid}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><img src="icons/icon-192.png" alt="logo"> Biotos CRM <span class="muted">v1.0</span>
      <span class="savebadge" id="savebadge">Salvato ✓</span>
      <span style="margin-left:8px"><select id="themeSel">
        <option value="auto">Auto</option><option value="dark">Scuro</option><option value="light">Chiaro</option><option value="hc">Contrasto alto</option>
      </select></span>
      <span class="right muted" id="accountBadge">—</span>
    </h1>
    <div class="globalsearch">
      <input id="gsearch" placeholder="Cerca in medici, farmacie, visite, appuntamenti…" autocapitalize="words" autocomplete="off">
      <div class="gsres" id="gsres"></div>
    </div>
    <div class="topnav" id="topnav">
      <button class="tabbtn active" data-tab="dashboard">🏠 Dashboard</button>
      <button class="tabbtn" data-tab="medici">👩‍⚕️ Medici</button>
      <button class="tabbtn" data-tab="farmacie">💊 Farmacie</button>
      <button class="tabbtn" data-tab="visite">📝 Visite</button>
      <button class="tabbtn" data-tab="agenda">🗓️ Agenda</button>
      <button class="tabbtn" data-tab="followup">⏰ Follow-up</button>
      <button class="tabbtn" data-tab="report">📈 Report</button>
      <button class="tabbtn" data-tab="io">⚙️ Dati</button>
    </div>
  </div>
</header>

<main class="wrap" id="mainwrap">
  <!-- DASHBOARD -->
  <section id="dashboard" class="grid">
    <div class="kpis">
      <div class="pan"><h3>Medici schedati</h3><div class="value stat" id="k_medici">0</div></div>
      <div class="pan"><h3>Farmacie schedate</h3><div class="value stat" id="k_farmacie">0</div></div>
      <div class="pan"><h3>Visite totali</h3><div class="value stat" id="k_visite">0</div></div>
      <div class="pan"><h3>Appuntamenti futuri</h3><div class="value stat" id="k_appt">0</div></div>
      <div class="pan"><h3>Follow-up scaduti</h3><div class="value stat" id="k_fu_over">0</div></div>
      <div class="pan"><h3>Follow-up prossimi 3 gg</h3><div class="value stat" id="k_fu_soon">0</div></div>
    </div>
    <div class="pan">
      <h3 style="margin:0 0 6px">Oggi e prossimi</h3>
      <div class="tablewrap"><table id="tbl_dash"><thead><tr>
        <th>Data</th><th>Tipo</th><th>Titolo</th><th>Rif.</th><th>Contatto</th><th>Azioni</th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_dash"></div>
    </div>
  </section>

  <!-- MEDICI -->
  <section id="medici" class="grid hidden">
    <div class="pan">
      <details>
        <summary>Ricerca avanzata</summary>
        <div class="row">
          <div><label>Nome/Cognome</label><input id="m_q" placeholder="es. Rossi Mario"></div>
          <div><label>Comune</label><input id="m_q_comune" placeholder="es. Cosenza"></div>
          <div><label>Specialità</label><select id="m_q_spec"><option value="">Tutte</option><option>Ginecologia</option><option>MMG</option><option>Altro</option></select></div>
          <div><label>Tag contiene</label><input id="m_q_tag" placeholder="es. top, FV"></div>
          <div class="right"><label>&nbsp;</label><button class="btn ghost" id="m_btn_sort">Ordina A→Z</button></div>
        </div>
      </details>
      <div class="row"><div class="right"><button class="btn" id="btn_exp_med">⬇️ Export CSV</button><button class="btn" id="btn_imp_med">⬆️ Import CSV</button></div></div>
      <div class="tablewrap"><table id="tbl_medici"><thead><tr>
        <th>Nome</th><th>Specialità</th><th>Studio</th><th>Comune</th><th>Tag</th><th>Contatti</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_medici"></div>
      <div class="right muted" id="info_medici"></div>
    </div>
  </section>

  <!-- FARMACIE -->
  <section id="farmacie" class="grid hidden">
    <div class="pan">
      <details><summary>Ricerca avanzata</summary>
        <div class="row">
          <div><label>Ragione Sociale</label><input id="f_q" placeholder="es. Farmacia Centrale"></div>
          <div><label>Comune</label><input id="f_q_comune" placeholder="es. Rende"></div>
          <div><label>Tag contiene</label><input id="f_q_tag" placeholder="es. FV, vetrina"></div>
          <div class="right"><label>&nbsp;</label><button class="btn ghost" id="f_btn_sort">Ordina A→Z</button></div>
        </div>
      </details>
      <div class="row"><div class="right"><button class="btn" id="btn_exp_far">⬇️ Export CSV</button><button class="btn" id="btn_imp_far">⬆️ Import CSV</button></div></div>
      <div class="tablewrap"><table id="tbl_farmacie"><thead><tr>
        <th>Ragione Sociale</th><th>Comune</th><th>Tag</th><th>Indirizzo</th><th>Contatti</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_farmacie"></div>
      <div class="right muted" id="info_farmacie"></div>
    </div>
  </section>

  <!-- VISITE -->
  <section id="visite" class="grid hidden">
    <div class="pan">
      <details><summary>Ricerca avanzata</summary>
        <div class="row">
          <div><label>Dal</label><input type="date" id="v_q_from"></div>
          <div><label>Al</label><input type="date" id="v_q_to"></div>
          <div><label>Tipo</label><select id="v_q_tipo"><option value="">Tutti</option><option>Medico</option><option>Farmacia</option></select></div>
          <div><label>Esito</label><select id="v_q_esito"><option value="">Tutti</option><option>Incontro svolto</option><option>Rifiutato</option><option>Assente</option><option>Solo materiale</option><option>Nuovo contatto</option></select></div>
          <div><label>Prodotti</label><select id="v_q_prod"><option value="">Tutti</option><option>FV</option><option>FL</option><option>Entrambi</option><option>—</option></select></div>
          <div><label>Tag contiene</label><input id="v_q_tag" placeholder="es. FV demo"></div>
          <div class="right"><label>&nbsp;</label><button class="btn ghost" id="v_btn_sort">Ordina recenti</button></div>
        </div>
      </details>
      <div class="row"><div class="right"><button class="btn" id="btn_exp_vis">⬇️ Export CSV</button></div></div>
      <div class="tablewrap"><table id="tbl_visite"><thead><tr>
        <th>Data</th><th>Tipo</th><th>Rif.</th><th>Prodotti</th><th>Esito</th><th>Next</th><th>Follow-up</th><th>Tag</th><th>Ref.</th><th>Ord FV/FL</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_visite"></div>
      <div class="right muted" id="info_visite"></div>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="agenda" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Dal</label><input type="date" id="a_from"></div>
        <div><label>Al</label><input type="date" id="a_to"></div>
        <div class="right"><label>&nbsp;</label><button class="btn" id="btn_new_appt">+ Appuntamento</button></div>
      </div>
      <div class="tablewrap"><table id="tbl_agenda"><thead><tr>
        <th>Data</th><th>Ora</th><th>Tipo</th><th>Titolo</th><th>Rif.</th><th>Contatto</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_agenda"></div>
      <div class="right muted" id="info_agenda"></div>
    </div>
  </section>

  <!-- FOLLOW-UP -->
  <section id="followup" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Filtra per stato</label>
          <select id="fu_state">
            <option value="all">Tutti</option>
            <option value="over">Scaduti</option>
            <option value="soon">Prossimi 3 gg</option>
            <option value="future">Oltre 3 gg</option>
          </select>
        </div>
        <div class="right"><label>&nbsp;</label><button class="btn" id="btn_exp_ics">📅 Esporta iCal</button></div>
      </div>
      <div class="tablewrap"><table id="tbl_follow"><thead><tr>
        <th>Data</th><th>Tipo</th><th>Rif.</th><th>Prossimo step</th><th>Contatto</th><th>Note</th><th></th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_follow"></div>
    </div>
  </section>

  <!-- REPORT -->
  <section id="report" class="grid hidden">
    <div class="pan">
      <div class="row">
        <div><label>Mese</label><input type="month" id="r_month"></div>
        <div><label>Tag filtro</label><input id="r_tag" placeholder="es. FV, top"></div>
        <div><label>Referente</label><select id="r_refe"><option value="">Tutti</option><option>Stefano</option><option>Mariangela</option></select></div>
        <div class="right"><label>&nbsp;</label><button class="btn" id="btn_exp_rep">⬇️ Export CSV</button></div>
      </div>
      <div class="kpis">
        <div class="pan"><h3>Visite mese</h3><div class="value" id="rk_visite">0</div></div>
        <div class="pan"><h3>Nuovi contatti</h3><div class="value" id="rk_nuovi">0</div></div>
        <div class="pan"><h3>FU creati</h3><div class="value" id="rk_fu">0</div></div>
        <div class="pan"><h3>Ordini stimati FV/FL</h3><div class="value"><span id="rk_fv">0</span>/<span id="rk_fl">0</span></div></div>
      </div>
      <div class="tablewrap"><table id="tbl_rep"><thead><tr>
        <th>Data</th><th>Tipo</th><th>Rif.</th><th>Prodotti</th><th>Esito</th><th>Tag</th><th>Ref.</th><th>FU</th><th>Ord FV/FL</th>
      </tr></thead><tbody></tbody></table></div>
      <div class="cards" id="cards_rep"></div>
    </div>
  </section>

  <!-- IO / ACCOUNT -->
  <section id="io" class="grid hidden">
    <div class="pan">
      <h3 style="margin:0 0 8px">Account</h3>
      <div class="row">
        <div><label>Nome</label><input id="acc_name"></div>
        <div><label>Email (login)</label><input id="acc_email" autocapitalize="none"></div>
        <div><label>Ruolo</label><input id="acc_role" disabled></div>
      </div>
      <div class="row"><button class="btn primary" id="btn_acc_save">Salva profilo</button><button class="btn" id="btn_pw">Cambia password</button><button class="btn" id="btn_logout">Logout</button></div>
    </div>
    <div class="pan" id="team_pan" style="display:none">
      <h3 style="margin:0 0 8px">Team (solo master)</h3>
      <div class="row">
        <div><label>Nuovo utente – Nome</label><input id="u_name"></div>
        <div><label>Email</label><input id="u_email" autocapitalize="none"></div>
        <div><label>Password</label><input id="u_pw" type="password"></div>
      </div>
      <div class="row"><button class="btn" id="btn_add_user">Aggiungi utente</button></div>
      <div class="tablewrap"><table id="tbl_users"><thead><tr><th>Nome</th><th>Email</th><th>Ruolo</th><th>Azioni</th></tr></thead><tbody></tbody></table></div>
    </div>
    <div class="pan">
      <h3 style="margin:0 8px 8px">Impostazioni</h3>
      <div class="row">
        <div><label>Colore accento</label>
          <select id="cfg_accent">
            <option value="#0b8f5c">Verde Biotos</option>
            <option value="#0ea5e9">Azzurro</option>
            <option value="#d946ef">Magenta</option>
            <option value="#f59e0b">Ambra</option>
            <option value="#ef4444">Rosso</option>
          </select>
        </div>
        <div><label>Campi obbligatori per visita</label>
          <select id="cfg_req">
            <option value="basic">Base (data, tipo, riferimento)</option>
            <option value="strict">Rigidi (+ esito)</option>
          </select>
        </div>
        <div><label>Default follow-up (giorni)</label><input id="cfg_fu" type="number" value="7" min="0" step="1"></div>
      </div>
      <div class="row"><button class="btn primary" id="btn_save_cfg">Salva impostazioni</button></div>
    </div>
    <div class="pan">
      <h3 style="margin:0 0 8px">Backup & Dati</h3>
      <div class="row">
        <button class="btn" id="btn_exp_json">⬇️ Esporta backup JSON</button>
        <input type="file" id="inp_imp_json" accept="application/json" class="btn">
        <button class="btn" id="btn_clear" title="Cancella tutti i dati (profilo/account corrente)">🗑️ Reset dati</button>
      </div>
      <p class="muted">I dati restano sul dispositivo (IndexedDB + LocalStorage). Uso attuale: <span id="stor_usage">–</span></p>
    </div>
  </section>
</main>

<!-- NAV MOBILE -->
<nav class="bottomnav" id="bottomnav" aria-label="Sezioni principali">
  <button class="tabbtn active" data-tab="dashboard" aria-label="Dashboard"><span class="ico">🏠</span><span class="label">Home</span></button>
  <button class="tabbtn" data-tab="medici" aria-label="Medici"><span class="ico">👩‍⚕️</span><span class="label">Medici</span></button>
  <button class="tabbtn" data-tab="farmacie" aria-label="Farmacie"><span class="ico">💊</span><span class="label">Farmacie</span></button>
  <button class="tabbtn" data-tab="visite" aria-label="Visite"><span class="ico">📝</span><span class="label">Visite</span></button>
  <button class="tabbtn" data-tab="agenda" aria-label="Agenda"><span class="ico">🗓️</span><span class="label">Agenda</span></button>
  <button class="tabbtn" data-tab="followup" aria-label="Follow-up"><span class="ico">⏰</span><span class="label">F/U</span></button>
  <button class="tabbtn" data-tab="report" aria-label="Report"><span class="ico">📈</span><span class="label">Report</span></button>
  <button class="tabbtn" data-tab="io" aria-label="Dati e impostazioni"><span class="ico">⚙️</span><span class="label">Dati</span></button>
</nav>

<!-- FAB -->
<button class="fab" id="fab" title="Azioni">＋</button>
<div class="fabmenu" id="fabmenu" aria-label="Azioni rapide">
  <button class="btn" id="act_new_med">+ Medico</button>
  <button class="btn" id="act_new_far">+ Farmacia</button>
  <button class="btn" id="act_new_vis">+ Visita</button>
  <button class="btn" id="act_new_appt2">+ Appuntamento</button>
</div>

<!-- SHEETS / MODALS -->
<div class="sheet" id="sheet_medico"><div class="panel">
  <button class="close" data-close="sheet_medico">✕</button><h3 id="sheet_medico_title">Nuovo medico</h3>
  <div class="row"><div><label>Titolo</label><input id="m_titolo"></div><div><label>Nome *</label><input id="m_nome" required></div><div><label>Cognome *</label><input id="m_cognome" required></div>
  <div><label>Specialità</label><select id="m_spec"><option>Ginecologia</option><option>MMG</option><option>Altro</option></select></div></div>
  <div class="row"><div><label>Studio/Struttura</label><input id="m_struttura"></div><div><label>Comune</label><input id="m_comune"></div><div><label>Indirizzo</label><input id="m_indirizzo"></div></div>
  <div class="row"><div><label>Telefono</label><input id="m_tel" type="tel" inputmode="tel" pattern="[0-9+\s()-]{6,}"></div><div><label>Email</label><input id="m_email" type="email" inputmode="email" autocapitalize="none"></div></div>
  <div class="row"><div><label>Tag (virgola)</label><input id="m_tags" placeholder="es. top, FV"></div></div>
  <div class="row"><div><label>Note</label><input id="m_note" maxlength="240"></div></div>
  <div class="row"><button class="btn primary block" id="btn_save_medico">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_farmacia"><div class="panel">
  <button class="close" data-close="sheet_farmacia">✕</button><h3 id="sheet_farmacia_title">Nuova farmacia</h3>
  <div class="row"><div><label>Ragione Sociale *</label><input id="f_ragione" required></div><div><label>Direttore</label><input id="f_direttore"></div><div><label>Comune</label><input id="f_comune"></div><div><label>Indirizzo</label><input id="f_indirizzo"></div></div>
  <div class="row"><div><label>Telefono</label><input id="f_tel" type="tel" inputmode="tel" pattern="[0-9+\s()-]{6,}"></div><div><label>Email</label><input id="f_email" type="email" inputmode="email" autocapitalize="none"></div></div>
  <div class="row"><div><label>Tag (virgola)</label><input id="f_tags" placeholder="es. FV, vetrina"></div><div><label>Note</label><input id="f_note" maxlength="240"></div></div>
  <div class="row"><button class="btn primary block" id="btn_save_farmacia">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_visita"><div class="panel">
  <button class="close" data-close="sheet_visita">✕</button><h3 id="sheet_visita_title">Nuova visita</h3>
  <div class="row"><div><label>Data *</label><input type="date" id="v_data" required></div><div><label>Tipo visita *</label><select id="v_tipo" required><option>Medico</option><option>Farmacia</option></select></div><div><label>Riferimento *</label><select id="v_ref" required></select></div><div><label>Referente</label><select id="v_refe"><option>Stefano</option><option>Mariangela</option></select></div></div>
  <div class="row"><div><label>Obiettivo visita</label><input id="v_obj" maxlength="140" placeholder="es. presentazione FV, riordino FL..."></div><div><label>Prodotti</label><select id="v_prod"><option>FV</option><option>FL</option><option>Entrambi</option><option>—</option></select></div><div><label>Materiali consegnati</label><input id="v_mat" maxlength="140" placeholder="folder, scheda, locandina..."></div></div>
  <div class="row"><div><label>Esito</label><select id="v_esito"><option>Incontro svolto</option><option>Rifiutato</option><option>Assente</option><option>Solo materiale</option><option>Nuovo contatto</option></select></div><div><label>Prossimo step</label><select id="v_next"><option value="">—</option><option>Follow-up telefonico</option><option>Invio materiali</option><option>Richiesta ordine</option><option>Demo/Approfondimento</option><option>Altro</option></select></div>
  <div><label>Data follow-up</label><input type="date" id="v_follow"><div class="chips"><button type="button" class="btn" data-addd="1">+1g</button><button type="button" class="btn" data-addd="3">+3g</button><button type="button" class="btn" data-addd="7">+7g</button><button type="button" class="btn" data-addd="14">+14g</button></div></div></div>
  <div class="row"><div><label>Tag (virgola)</label><input id="v_tags" placeholder="es. FV demo"></div><div><label>Ordine stimato FV</label><input id="v_fv" type="number" min="0" step="1" value="0" inputmode="numeric"></div><div><label>Ordine stimato FL</label><input id="v_fl" type="number" min="0" step="1" value="0" inputmode="numeric"></div></div>
  <div class="row"><div><label>Note esito</label><input id="v_note" maxlength="240"></div></div>
  <div class="row"><button class="btn primary block" id="btn_save_visita">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_appt"><div class="panel">
  <button class="close" data-close="sheet_appt">✕</button><h3 id="sheet_appt_title">Nuovo appuntamento</h3>
  <div class="row"><div><label>Data *</label><input type="date" id="a_data" required></div><div><label>Ora</label><input type="time" id="a_ora"></div><div><label>Tipo *</label><select id="a_tipo"><option>Medico</option><option>Farmacia</option><option>Altro</option></select></div><div><label>Riferimento</label><select id="a_ref"></select></div></div>
  <div class="row"><div><label>Titolo *</label><input id="a_tit" required placeholder="es. Presentazione FloraVamp"></div><div><label>Note</label><input id="a_note" maxlength="240"></div></div>
  <div class="row"><button class="btn primary block" id="btn_save_appt">Salva</button></div>
</div></div>

<div class="sheet" id="sheet_onb"><div class="panel">
  <button class="close" data-close="sheet_onb">✕</button><h3>Benvenuto in Biotos CRM</h3>
  <ol>
    <li>Crea un <b>profilo</b> (es. “Cosenza – Mariangela”).</li>
    <li>Aggiungi <b>Medici/Farmacie</b>.</li>
    <li>Registra la <b>prima visita</b> e imposta un <b>follow-up</b>.</li>
  </ol>
  <div class="row"><div><label>Nome profilo</label><input id="onb_profile" placeholder="es. Cosenza – Mariangela"></div></div>
  <div class="row"><button class="btn primary" id="onb_start">Inizia</button><button class="btn" id="onb_sample">Carica dati demo</button></div>
</div></div>

<div class="sheet" id="sheet_profile"><div class="panel">
  <button class="close" data-close="sheet_profile">✕</button><h3>Seleziona/Crea profilo</h3>
  <div id="profile_list" class="cards"></div>
  <div class="row"><div><label>Nuovo profilo</label><input id="new_profile" placeholder="es. Calabria – Team A"></div></div>
  <div class="row"><button class="btn primary" id="btn_add_profile">Crea e usa</button></div>
</div></div>

<div class="sheet" id="sheet_auth"><div class="panel">
  <button class="close" data-close="sheet_auth">✕</button><h3>Accesso</h3>
  <div class="row">
    <div><label>Email</label><input id="auth_email" autocapitalize="none"></div>
    <div><label>Password</label><input id="auth_pw" type="password"></div>
  </div>
  <div class="row"><button class="btn primary" id="btn_login">Entra</button><button class="btn" id="btn_show_reg">Registrati</button></div>
  <details style="margin-top:8px"><summary>Problemi di accesso?</summary><p class="muted">Non c'è un server: il reset password è possibile solo se sei già autenticato come master (sezione Account).</p></details>
</div></div>

<div class="sheet" id="sheet_reg"><div class="panel">
  <button class="close" data-close="sheet_reg">✕</button><h3>Registrazione</h3>
  <p class="muted">Il primo utente creato è <b>master</b>. Potrai poi aggiungere utenti secondari dal pannello Account.</p>
  <div class="row"><div><label>Nome</label><input id="reg_name"></div><div><label>Email</label><input id="reg_email" autocapitalize="none"></div><div><label>Password</label><input id="reg_pw" type="password"></div></div>
  <div class="row"><button class="btn primary" id="btn_reg">Crea account</button></div>
</div></div>

<div class="sheet" id="sheet_pw"><div class="panel">
  <button class="close" data-close="sheet_pw">✕</button><h3>Cambia password</h3>
  <div class="row"><div><label>Password attuale</label><input id="pw_old" type="password"></div><div><label>Nuova password</label><input id="pw_new" type="password"></div></div>
  <div class="row"><button class="btn primary" id="btn_pw_save">Aggiorna</button></div>
</div></div>

<div class="toast" id="toast"></div>

<script>
/*** CORE UTILS ***/
const $=id=>document.getElementById(id);
function todayISO(){return new Date().toISOString().slice(0,10)}
function addDays(iso,d){const x=new Date(iso||new Date());x.setDate(x.getDate()+d);return x.toISOString().slice(0,10)}
function uid(){return 'id_'+Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4)}
function tagsArr(val){return (val||'').split(',').map(s=>s.trim()).filter(Boolean)}
function debounce(fn,ms){let to; return (...a)=>{clearTimeout(to); to=setTimeout(()=>fn(...a),ms);} }
function dl(fn,text){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'}));a.download=fn;a.click();}
function toast(t){ const el=$('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500); }

/*** THEME ***/
const themeSel = $('themeSel');
const savedTheme = localStorage.getItem('theme') || 'auto';
themeSel.value = savedTheme; applyTheme(savedTheme);
themeSel.addEventListener('change', ()=>{ localStorage.setItem('theme', themeSel.value); applyTheme(themeSel.value); });
function applyTheme(mode){
  const root = document.documentElement;
  if(mode==='auto'){ root.removeAttribute('data-theme'); if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches){ root.setAttribute('data-theme','light'); } }
  else{ root.setAttribute('data-theme', mode); }
  const cfg = JSON.parse(localStorage.getItem(accK()+'cfg')||'{}');
  const ac = cfg.accent || '#0b8f5c';
  root.style.setProperty('--accent', ac);
}

/*** DB (IndexedDB) ***/
const DB_NAME='biotos-crm'; const DB_STORE='kv'; const DB_ACCT='acct';
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,4);
  r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE,{keyPath:'key'});
    if(!db.objectStoreNames.contains(DB_ACCT)) db.createObjectStore(DB_ACCT,{keyPath:'id'}); };
  r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});}
async function idbGet(k){try{const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readonly'); const st=tx.objectStore(DB_STORE).get(k); st.onsuccess=()=>res(st.result?st.result.val:null); st.onerror=()=>rej(st.error);}); }catch(e){return null}}
async function idbSet(k,v){try{const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); tx.objectStore(DB_STORE).put({key:k,val:v});}); }catch(e){}}
async function acctAll(){const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_ACCT,'readonly'); const st=tx.objectStore(DB_ACCT).getAll(); st.onsuccess=()=>res(st.result||[]); st.onerror=()=>rej(st.error);});}
async function acctPut(obj){const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_ACCT,'readwrite'); tx.oncomplete=()=>res(obj); tx.onerror=()=>rej(tx.error); tx.objectStore(DB_ACCT).put(obj);});}
async function acctGet(id){const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_ACCT,'readonly'); const st=tx.objectStore(DB_ACCT).get(id); st.onsuccess=()=>res(st.result||null); st.onerror=()=>rej(st.error);});}
async function acctFindByEmail(email){const all=await acctAll(); return all.find(a=>a.email===email)||null}
async function acctRemove(id){const db=await idbOpen(); return await new Promise((res,rej)=>{const tx=db.transaction(DB_ACCT,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); tx.objectStore(DB_ACCT).delete(id);});}

/*** AUTH ***/
let ACCOUNT=null; // {id,name,email,role:'master'|'user', parentId?, pw:{salt,hash}}
function accK(){ return (ACCOUNT?ACCOUNT.id:'anon')+':'; }
async function cryptoHash(pw, salt){
  const enc = new TextEncoder();
  const data = enc.encode(pw + '|' + salt);
  const buf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function createAccount({name,email,password,role='master',parentId=null}){
  if(await acctFindByEmail(email)) throw new Error('Email già in uso');
  const salt = Math.random().toString(36).slice(2) + Date.now().toString(36).slice(-4);
  const hash = await cryptoHash(password, salt);
  const acct={id:'acct_'+uid(), name, email, role, parentId, pw:{salt,hash}, createdAt:new Date().toISOString()};
  await acctPut(acct);
  return acct;
}
async function login(email,pw){
  const a = await acctFindByEmail(email);
  if(!a) throw new Error('Account non trovato');
  const hash = await cryptoHash(pw, a.pw.salt);
  if(hash!==a.pw.hash) throw new Error('Password errata');
  ACCOUNT=a; localStorage.setItem('accountId', a.id); $('accountBadge').textContent = a.name + ' • ' + a.role;
  return a;
}
async function logout(){ ACCOUNT=null; localStorage.removeItem('accountId'); $('accountBadge').textContent='—'; ensureAuth(); }

/*** PROFILES ***/
function listProfiles(){ try{ return JSON.parse(localStorage.getItem(accK()+'profiles')||'[]'); }catch(_){ return []; } }
function setProfiles(arr){ localStorage.setItem(accK()+'profiles', JSON.stringify(arr)); }
let PROFILE = localStorage.getItem(accK()+'profile') || '';
function ensureProfile(){
  const arr=listProfiles();
  if(!PROFILE){ $('sheet_onb').classList.add('open'); }
  else { $('accountBadge').textContent += ' • profilo: '+PROFILE; }
}
$('onb_start').addEventListener('click', ()=>{
  const name = ($('onb_profile').value||'').trim() || 'Default';
  const arr = listProfiles(); if(!arr.includes(name)){ arr.push(name); setProfiles(arr); }
  localStorage.setItem(accK()+'profile', name); PROFILE=name; $('sheet_onb').classList.remove('open'); $('accountBadge').textContent+=' • profilo: '+PROFILE; appInitLoad();
});
$('onb_sample').addEventListener('click', ()=>{
  const name = ($('onb_profile').value||'').trim() || 'Demo';
  const arr = listProfiles(); if(!arr.includes(name)){ arr.push(name); setProfiles(arr); }
  localStorage.setItem(accK()+'profile', name); PROFILE=name; $('sheet_onb').classList.remove('open'); $('accountBadge').textContent+=' • profilo: '+PROFILE;
  medici=[{id:uid(), titolo:'Dott.', nome:'Mario', cognome:'Rossi', spec:'Ginecologia', struttura:'Studio Centro', comune:'Cosenza', indirizzo:'Via Roma 10', telefono:'0984...', email:'', tags:['top','FV'], note:''}];
  farmacie=[{id:uid(), ragione:'Farmacia Centrale', direttore:'Dott.ssa Bianchi', comune:'Rende', indirizzo:'P.zza Italia 2', telefono:'0984...', email:'', tags:['FV'], note:''}];
  const mid=medici[0].id; const today=todayISO();
  visite=[{id:uid(), data:today, tipo:'Medico', ref:mid, refe:'Stefano', obj:'Presentazione FV', prod:'FV', mat:'scheda', esito:'Nuovo contatto', next:'Follow-up telefonico', follow:addDays(today,7), fv:10, fl:0, tags:['demo'], note:'', contact:''}];
  appuntamenti=[{id:uid(), data:addDays(today,1), ora:'10:30', tipo:'Medico', ref:mid, tit:'Approfondimento FV', note:''}];
  persistAll(); renderAll();
});
function openProfileSheet(){
  const list=$('profile_list'); list.innerHTML='';
  listProfiles().forEach(n=>{
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main"><div class="title">${n}</div></div>
      <div class="actions"><button class="btn" onclick="useProfile('${n}')">Usa</button> <button class="btn" onclick="delProfile('${n}')">Elimina</button></div>`;
    list.appendChild(div);
  });
  $('sheet_profile').classList.add('open');
}
function useProfile(name){ localStorage.setItem(accK()+'profile', name); PROFILE=name; $('sheet_profile').classList.remove('open'); $('accountBadge').textContent = ACCOUNT.name+' • '+ACCOUNT.role+' • profilo: '+PROFILE; appInitLoad(); }
function delProfile(name){
  if(!confirm('Eliminare profilo?')) return;
  const arr=listProfiles().filter(x=>x!==name); setProfiles(arr); openProfileSheet();
}

/*** PERSISTENZA ***/
const savebadge=$('savebadge'); let saveTimer=null;
let medici=[], farmacie=[], visite=[], appuntamenti=[];
function K(key){ return (ACCOUNT?ACCOUNT.id:'anon') + ':' + (PROFILE||'default') + ':' + key; }
async function appInitLoad(){
  const [m,f,v,a,c]=await Promise.all([idbGet(K('medici')),idbGet(K('farmacie')),idbGet(K('visite')),idbGet(K('appuntamenti')),idbGet(K('cfg'))]);
  medici=Array.isArray(m)?m:[]; farmacie=Array.isArray(f)?f:[]; visite=Array.isArray(v)?v:[]; appuntamenti=Array.isArray(a)?a:[];
  if(c) localStorage.setItem(accK()+'cfg', JSON.stringify(c)); else localStorage.removeItem(accK()+'cfg');
  renderAll(); updateStorageUsage(); setupGlobalSearch();
}
function markSaving(){savebadge.textContent='Salvando…';} function markSaved(){savebadge.textContent='Salvato ✓';}
function persistAll(){markSaving(); clearTimeout(saveTimer); saveTimer=setTimeout(async()=>{
  await Promise.all([idbSet(K('medici'),medici),idbSet(K('farmacie'),farmacie),idbSet(K('visite'),visite),idbSet(K('appuntamenti'),appuntamenti), idbSet(K('cfg'), JSON.parse(localStorage.getItem(accK()+'cfg')||'{}'))]);
  markSaved(); updateStorageUsage();
},200);}

/*** GLOBAL SEARCH ***/
function setupGlobalSearch(){
  const inp=$('gsearch'), res=$('gsres');
  function buildItems(q){
    if(!q){res.style.display='none'; res.innerHTML=''; return;}
    const qq=q.toLowerCase();
    const items=[];
    medici.forEach(m=>{ if((m.nome+' '+m.cognome).toLowerCase().includes(qq) || (m.comune||'').toLowerCase().includes(qq) || (m.tags||[]).join(',').toLowerCase().includes(qq)) items.push({type:'Medico',title:`${m.nome} ${m.cognome}`, sub:(m.comune||'')+' '+(m.tags||[]).join(' · '), id:m.id}); });
    farmacie.forEach(f=>{ if((f.ragione||'').toLowerCase().includes(qq) || (f.comune||'').toLowerCase().includes(qq) || (f.tags||[]).join(',').toLowerCase().includes(qq)) items.push({type:'Farmacia',title:f.ragione, sub:(f.comune||'')+' '+(f.tags||[]).join(' · '), id:f.id}); });
    visite.forEach(v=>{ if((v.note||'').toLowerCase().includes(qq) || (v.obj||'').toLowerCase().includes(qq) || (v.tags||[]).join(',').toLowerCase().includes(qq)) items.push({type:'Visita',title: (v.obj||v.esito||'Visita') , sub: v.data+' – '+refNameBy(v.tipo,v.ref), id:v.id}); });
    appuntamenti.forEach(a=>{ if((a.tit||'').toLowerCase().includes(qq)) items.push({type:'Appt',title:a.tit, sub: a.data+(a.ora?(' '+a.ora):'')+' – '+refNameBy(a.tipo,a.ref), id:a.id}); });
    res.innerHTML = items.slice(0,60).map(it=>`<div class="card" data-gsel="${it.type}|${it.id}"><div class="main"><div class="title">${it.title}<span class="chip">${it.type}</span></div><div class="meta">${it.sub}</div></div></div>`).join('');
    res.style.display='block';
  }
  inp.addEventListener('input', debounce(()=>buildItems(inp.value), 200));
  res.addEventListener('click', e=>{ const card = e.target.closest('[data-gsel]'); if(!card) return; const [t,id]=card.getAttribute('data-gsel').split('|'); res.style.display='none';
    if(t==='Medico'){openTab('medici');} if(t==='Farmacia'){openTab('farmacie');} if(t==='Visita'){openTab('visite');} if(t==='Appt'){openTab('agenda');} });
}

/*** NAV MOBILE – drag scroll ***/
(function(){
  const nav=$('bottomnav');
  let isDown=false, startX=0, scrollL=0;
  nav.addEventListener('pointerdown', (e)=>{ isDown=true; startX=e.clientX; scrollL=nav.scrollLeft; nav.setPointerCapture(e.pointerId); });
  nav.addEventListener('pointermove', (e)=>{ if(!isDown) return; nav.scrollLeft = scrollL - (e.clientX - startX); });
  nav.addEventListener('pointerup', ()=>{ isDown=false; });
  nav.addEventListener('pointercancel', ()=>{ isDown=false; });
})();

/*** TABS ***/
function openTab(tab){
  document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll(`.tabbtn[data-tab="${tab}"]`).forEach(x=>x.classList.add('active'));
  document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(tab)?.classList.remove('hidden');
  if(tab==='dashboard') renderDashboard();
  if(tab==='visite') refreshVisitRefs();
  if(tab==='followup') renderFollowup();
  if(tab==='agenda') renderAgenda();
  if(tab==='report') renderReport();
  window.scrollTo({top:0, behavior:'smooth'});
}
document.querySelectorAll('.tabbtn').forEach(b=>b.addEventListener('click',()=> openTab(b.dataset.tab)));

/*** DATA HELPERS ***/
function refNameBy(tipo,ref){ if(tipo==='Medico'){const m=medici.find(x=>x.id===ref); return m?`${m.titolo||''} ${m.nome||''} ${m.cognome||''}`.trim():ref;} else if(tipo==='Farmacia'){const f=farmacie.find(x=>x.id===ref); return f?(f.ragione||ref):ref;} return ''; }
function contactInfoBy(tipo,ref){ if(tipo==='Medico'){const m=medici.find(x=>x.id===ref); return m?(m.telefono||m.email||''):'';} else if(tipo==='Farmacia'){const f=farmacie.find(x=>x.id===ref); return f?(f.telefono||f.email||''):'';} return ''; }

/*** DASHBOARD ***/
function renderDashboard(){
  $('k_medici').textContent=medici.length; $('k_farmacie').textContent=farmacie.length; $('k_visite').textContent=visite.length;
  const t=todayISO(), next3=addDays(t,3);
  $('k_fu_over').textContent=visite.filter(v=>v.follow&&v.follow<t).length;
  $('k_fu_soon').textContent=visite.filter(v=>v.follow&&v.follow>=t&&v.follow<=next3).length;
  $('k_appt').textContent=appuntamenti.filter(a=>a.data>=t).length;
  const data=[
    ...appuntamenti.filter(a=>a.data>=t).map(a=>({kind:'Appt', date:a.data, time:a.ora||'', title:a.tit, tipo:a.tipo, ref:a.ref, contact:contactInfoBy(a.tipo,a.ref), id:a.id})),
    ...visite.filter(v=>v.follow&&v.follow>=t&&v.follow<=next3).map(v=>({kind:'FU', date:v.follow, time:'', title:v.next||'Follow-up', tipo:v.tipo, ref:v.ref, contact:contactInfoBy(v.tipo,v.ref), id:v.id}))
  ].sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
  const tb=$('tbl_dash').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_dash'); cards.innerHTML='';
  data.slice(0,200).forEach(x=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.date}</td><td>${x.kind}</td><td>${x.title}</td><td>${refNameBy(x.tipo,x.ref)}</td><td>${x.contact||''}</td>
      <td>${x.kind==='Appt'?`<button class="btn" onclick="apptToVisit('${x.id}')">→ Visita</button>`:`<button class="btn" onclick="completeFU('${x.id}')">✓ Fatto</button>`}</td>`; tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main"><div class="title">${x.date}${x.time?(' '+x.time):''} • ${x.kind}<span class="chip">${refNameBy(x.tipo,x.ref)}</span></div><div class="meta">${x.title}</div><div class="meta">${x.contact||''}</div></div>
      <div class="actions">${x.kind==='Appt'?`<button class="btn" onclick="apptToVisit('${x.id}')">→ Visita</button>`:`<button class="btn" onclick="completeFU('${x.id}')">✓ Fatto</button>`}</div>`; cards.appendChild(div);
  });
}

/*** FAB ***/
const fab=$('fab'), fabmenu=$('fabmenu');
fab.addEventListener('click', ()=>{ fabmenu.classList.toggle('show'); });
document.addEventListener('click', e=>{ if(!fab.contains(e.target) && !fabmenu.contains(e.target)) fabmenu.classList.remove('show'); });
$('act_new_med').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); openMedicoSheet(); });
$('act_new_far').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); openFarmaciaSheet(); });
$('act_new_vis').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); openVisitaSheet(); });
$('act_new_appt2').addEventListener('click', ()=>{ fabmenu.classList.remove('show'); openApptSheet(); });

/*** MEDICI ***/
let editMedicoId=null, mSortAZ=true;
function openMedicoSheet(id=null){
  editMedicoId=id; const title=$('sheet_medico_title');
  if(id){ const m=medici.find(x=>x.id===id); if(!m) return; title.textContent='Modifica medico';
    ['m_titolo','m_nome','m_cognome','m_spec','m_struttura','m_comune','m_indirizzo','m_tel','m_email','m_note'].forEach(k=>$(k).value=m[k.replace('m_','')]||''); $('m_tags').value=(m.tags||[]).join(', '); }
  else { title.textContent='Nuovo medico'; ['m_titolo','m_nome','m_cognome','m_spec','m_struttura','m_comune','m_indirizzo','m_tel','m_email','m_note','m_tags'].forEach(k=>$(k).value=''); }
  $('sheet_medico').classList.add('open');
}
$('btn_save_medico').addEventListener('click',()=>{
  if(!$('m_nome').value.trim() || !$('m_cognome').value.trim()){ alert('Nome e Cognome sono obbligatori.'); return; }
  const m={id:editMedicoId||uid(), titolo:$('m_titolo').value.trim(), nome:$('m_nome').value.trim(), cognome:$('m_cognome').value.trim(),
    spec:$('m_spec').value, struttura:$('m_struttura').value.trim(), comune:$('m_comune').value.trim(), indirizzo:$('m_indirizzo').value.trim(),
    telefono:$('m_tel').value.trim(), email:$('m_email').value.trim(), tags:tagsArr($('m_tags').value), note:$('m_note').value.trim()};
  if(editMedicoId){ const i=medici.findIndex(x=>x.id===editMedicoId); medici[i]=m; } else { medici.unshift(m); }
  persistAll(); closeSheets(); renderMedici(); refreshVisitRefs(); renderAgenda(); renderDashboard(); toast('Medico salvato');
});
function renderMedici(){
  const name=($('m_q')?.value||'').toLowerCase(), comune=($('m_q_comune')?.value||'').toLowerCase(), spec=$('m_q_spec')?.value||'', tag=($('m_q_tag')?.value||'').toLowerCase();
  let arr=medici.filter(m=>((m.nome+' '+m.cognome).toLowerCase().includes(name)) && (m.comune||'').toLowerCase().includes(comune) && (!spec || m.spec===spec) && (!tag || (m.tags||[]).join(',').toLowerCase().includes(tag)));
  arr.sort((a,b)=> (mSortAZ?1:-1) * ( (a.cognome||'').localeCompare(b.cognome||'') || (a.nome||'').localeCompare(b.nome||'') ));
  const tb=$('tbl_medici').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_medici'); cards.innerHTML='';
  arr.forEach(m=>{
    const tel=m.telefono?`<a href="tel:${m.telefono}">📞 ${m.telefono}</a>`:''; const mail=m.email?`<a href="mailto:${m.email}">✉️ ${m.email}</a>`:'';
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td><b>${m.titolo||''} ${m.nome||''} ${m.cognome||''}</b></td>
      <td><span class="pill">${m.spec||''}</span></td>
      <td>${m.struttura||''}</td><td>${m.comune||''}</td>
      <td>${(m.tags||[]).map(t=>`<span class='pill'>${t}</span>`).join(' ')}</td>
      <td>${[tel,mail].filter(Boolean).join('<br>')}</td><td>${m.note||''}</td>
      <td><button class="btn" onclick="openMedicoSheet('${m.id}')">Modifica</button> <button class="btn" onclick="openVisitaSheet(); document.getElementById('v_tipo').value='Medico'; refreshVisitRefs(); document.getElementById('v_ref').value='${m.id}';">+ Visita</button> <button class="btn" onclick="openApptSheet('Medico','${m.id}')">+ Appunt.</button></td>`;
    tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${m.titolo||''} ${m.nome||''} ${m.cognome||''}<span class="chip">${m.spec||''}</span></div>
      <div class="subtitle">${m.struttura||''} • ${m.comune||''}</div>
      <div class="meta">${(m.tags||[]).map(t=>`<span class='chip'>${t}</span>`).join(' ')}</div>
      <div class="meta">${m.telefono?('<a href="tel:'+m.telefono+'">📞 '+m.telefono+'</a>'):''} ${m.email?(' · <a href="mailto:'+m.email+'">✉️ '+m.email+'</a>'):''}</div>
      <div class="meta">${m.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="openMedicoSheet('${m.id}')">Modifica</button><button class="btn" onclick="openVisitaSheet(); document.getElementById('v_tipo').value='Medico'; refreshVisitRefs(); document.getElementById('v_ref').value='${m.id}';">+ Visita</button><button class="btn" onclick="openApptSheet('Medico','${m.id}')">+ Appunt.</button></div>`;
    cards.appendChild(div);
  });
  $('info_medici').textContent = `${arr.length} medici`;
}
['m_q','m_q_comune','m_q_spec','m_q_tag'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', debounce(renderMedici, 250));});
$('m_btn_sort').addEventListener('click', ()=>{ mSortAZ=!mSortAZ; $('m_btn_sort').textContent = mSortAZ?'Ordina A→Z':'Ordina Z→A'; renderMedici();});

/*** FARMACIE ***/
let editFarmaciaId=null, fSortAZ=true;
function openFarmaciaSheet(id=null){
  editFarmaciaId=id; const title=$('sheet_farmacia_title');
  if(id){ const x=farmacie.find(o=>o.id===id); if(!x) return; title.textContent='Modifica farmacia';
    ['f_ragione','f_direttore','f_comune','f_indirizzo','f_tel','f_email','f_note'].forEach(k=>$(k).value=x[k.replace('f_','')]||''); $('f_tags').value=(x.tags||[]).join(', '); }
  else { title.textContent='Nuova farmacia'; ['f_ragione','f_direttore','f_comune','f_indirizzo','f_tel','f_email','f_note','f_tags'].forEach(k=>$(k).value=''); }
  $('sheet_farmacia').classList.add('open');
}
$('btn_save_farmacia').addEventListener('click',()=>{
  if(!$('f_ragione').value.trim()){ alert('Ragione sociale obbligatoria.'); return; }
  const f={id:editFarmaciaId||uid(), ragione:$('f_ragione').value.trim(), direttore:$('f_direttore').value.trim(), comune:$('f_comune').value.trim(),
    indirizzo:$('f_indirizzo').value.trim(), telefono:$('f_tel').value.trim(), email:$('f_email').value.trim(), tags:tagsArr($('f_tags').value), note:$('f_note').value.trim()};
  if(editFarmaciaId){ const i=farmacie.findIndex(o=>o.id===editFarmaciaId); farmacie[i]=f; } else { farmacie.unshift(f); }
  persistAll(); closeSheets(); renderFarmacie(); refreshVisitRefs(); renderAgenda(); renderDashboard(); toast('Farmacia salvata');
});
function renderFarmacie(){
  const q=($('f_q')?.value||'').toLowerCase(), com=($('f_q_comune')?.value||'').toLowerCase(), tag=($('f_q_tag')?.value||'').toLowerCase();
  let arr=farmacie.filter(x=>(x.ragione||'').toLowerCase().includes(q) && (x.comune||'').toLowerCase().includes(com) && (!tag || (x.tags||[]).join(',').toLowerCase().includes(tag)));
  arr.sort((a,b)=> (fSortAZ?1:-1) * ( (a.comune||'').localeCompare(b.comune||'') || (a.ragione||'').localeCompare(b.ragione||'') ));
  const tb=$('tbl_farmacie').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_farmacie'); cards.innerHTML='';
  arr.forEach(x=>{
    const tel=x.telefono?`<a href="tel:${x.telefono}">📞 ${x.telefono}</a>`:''; const mail=x.email?`<a href="mailto:${x.email}">✉️ ${x.email}</a>`:'';
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td><b>${x.ragione||''}</b> ${x.direttore?'<div class=muted>'+x.direttore+'</div>':''}</td>
      <td>${x.comune||''}</td><td>${(x.tags||[]).map(t=>`<span class='pill'>${t}</span>`).join(' ')}</td><td>${x.indirizzo||''}</td>
      <td>${[tel,mail].filter(Boolean).join('<br>')}</td><td>${x.note||''}</td>
      <td><button class="btn" onclick="openFarmaciaSheet('${x.id}')">Modifica</button> <button class="btn" onclick="openVisitaSheet(); document.getElementById('v_tipo').value='Farmacia'; refreshVisitRefs(); document.getElementById('v_ref').value='${x.id}';">+ Visita</button> <button class="btn" onclick="openApptSheet('Farmacia','${x.id}')">+ Appunt.</button></td>`;
    tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${x.ragione||''}<span class="chip">${x.comune||''}</span></div>
      <div class="meta">${(x.tags||[]).map(t=>`<span class='chip'>${t}</span>`).join(' ')}</div>
      <div class="subtitle">${x.indirizzo||''}</div>
      <div class="meta">${x.telefono?('<a href="tel:'+x.telefono+'">📞 '+x.telefono+'</a>'):''} ${x.email?(' · <a href="mailto:'+x.email+'">✉️ '+x.email+'</a>'):''}</div>
      <div class="meta">${x.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="openFarmaciaSheet('${x.id}')">Modifica</button><button class="btn" onclick="openVisitaSheet(); document.getElementById('v_tipo').value='Farmacia'; refreshVisitRefs(); document.getElementById('v_ref').value='${x.id}';">+ Visita</button><button class="btn" onclick="openApptSheet('Farmacia','${x.id}')">+ Appunt.</button></div>`;
    cards.appendChild(div);
  });
  $('info_farmacie').textContent = `${arr.length} farmacie`;
}
['f_q','f_q_comune','f_q_tag'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', debounce(renderFarmacie, 250));});
$('f_btn_sort').addEventListener('click', ()=>{ fSortAZ=!fSortAZ; $('f_btn_sort').textContent = fSortAZ?'Ordina A→Z':'Ordina Z→A'; renderFarmacie();});

/*** VISITE ***/
let editVisitaId=null, vSortRecent=true;
function openVisitaSheet(id=null, duplicate=false){
  editVisitaId = duplicate ? null : id; const title=$('sheet_visita_title');
  if(id){ const v=visite.find(o=>o.id===id); if(!v) return; title.textContent= duplicate ? 'Duplica visita' : 'Modifica visita';
    ['v_data','v_tipo','v_ref','v_refe','v_obj','v_prod','v_mat','v_esito','v_next','v_follow','v_fv','v_fl','v_note'].forEach(k=>{$(k).value=(v[k.replace('v_','')]??'');}); $('v_tags').value=(v.tags||[]).join(', ');
    if(duplicate){ $('v_data').value = todayISO(); }
  }else{ title.textContent='Nuova visita'; ['v_data','v_obj','v_mat','v_follow','v_note','v_tags'].forEach(k=>$(k).value=''); $('v_fv').value=0; $('v_fl').value=0; $('v_tipo').value='Medico'; $('v_refe').value='Stefano'; }
  refreshVisitRefs(); $('sheet_visita').classList.add('open');
}
$('btn_save_visita').addEventListener('click',()=>{
  const req = JSON.parse(localStorage.getItem(accK()+'cfg')||'{}').req || 'basic';
  if(!$('v_data').value || !$('v_tipo').value || !$('v_ref').value || (req==='strict' && !$('v_esito').value)){ alert('Compila i campi obbligatori.'); return; }
  const v={id:editVisitaId||uid(),data:$('v_data').value||todayISO(),tipo:$('v_tipo').value,ref:$('v_ref').value,refe:$('v_refe').value,
    obj:$('v_obj').value.trim(),prod:$('v_prod').value,mat:$('v_mat').value.trim(),esito:$('v_esito').value,
    next:$('v_next').value,follow:$('v_follow').value||'',fv:+$('v_fv').value||0,fl:+$('v_fl').value||0,tags:tagsArr($('v_tags').value),note:$('v_note').value.trim(),
    contact:contactInfoBy($('v_tipo').value,$('v_ref').value)};
  if(!v.follow && v.next){ const off = parseInt((JSON.parse(localStorage.getItem(accK()+'cfg')||'{}').fu||'7'),10)||7; v.follow = addDays(v.data, off); }
  if(editVisitaId){ const i=visite.findIndex(o=>o.id===editVisitaId); visite[i]=v; } else { visite.unshift(v); }
  persistAll(); closeSheets(); renderVisite(); renderDashboard(); renderFollowup(); toast('Visita salvata');
});
document.addEventListener('click', (ev)=>{ const b=ev.target.closest('[data-addd]'); if(!b) return; const d= parseInt(b.getAttribute('data-addd')); $('v_follow').value = addDays($('v_data').value||todayISO(), d);});
function refreshVisitRefs(){const sel=$('v_ref'); if(!sel) return; sel.innerHTML=''; const tipo=$('v_tipo').value; const list=(tipo==='Medico'?medici:farmacie);
  list.forEach(x=>{const opt=document.createElement('option'); opt.value=x.id; opt.textContent=(tipo==='Medico'?`${x.titolo||''} ${x.nome||''} ${x.cognome||''}`.trim():(x.ragione||x.id)); sel.appendChild(opt);});}
$('v_tipo').addEventListener('change',refreshVisitRefs);
function renderVisite(){
  const from=$('v_q_from')?.value||'', to=$('v_q_to')?.value||'', tipo=$('v_q_tipo')?.value||'', esito=$('v_q_esito')?.value||'', prod=$('v_q_prod')?.value||'', tag=($('v_q_tag')?.value||'').toLowerCase();
  let arr=visite.filter(v=>{
    const okDate = (!from || v.data>=from) && (!to || v.data<=to);
    const okTipo = (!tipo || v.tipo===tipo);
    const okEsito = (!esito || v.esito===esito);
    const okProd = (!prod || v.prod===prod);
    const okTag = (!tag || (v.tags||[]).join(',').toLowerCase().includes(tag));
    return okDate && okTipo && okEsito && okProd && okTag;
  });
  arr.sort((a,b)=> (vSortRecent?-1:1) * a.data.localeCompare(b.data) );
  const tb=$('tbl_visite').querySelector('tbody'); tb.innerHTML='';
  const cards=$('cards_visite'); cards.innerHTML='';
  arr.forEach(v=>{
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${v.data}</td><td>${v.tipo}</td><td>${refNameBy(v.tipo,v.ref)}</td>
      <td>${v.prod}</td><td>${v.esito}</td><td>${v.next||''}</td><td>${v.follow||''}</td>
      <td>${(v.tags||[]).map(t=>`<span class='pill'>${t}</span>`).join(' ')}</td>
      <td>${v.refe}</td><td>${v.fv||0}/${v.fl||0}</td><td>${v.note||''}</td>
      <td><button class="btn" onclick="openVisitaSheet('${v.id}')">Modifica</button> <button class="btn" onclick="openVisitaSheet('${v.id}',true)">Duplica</button> <button class="btn" onclick="delVisita('${v.id}')">Elimina</button></td>`;
    tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${v.data} • ${v.tipo}<span class="chip">${refNameBy(v.tipo,v.ref)}</span></div>
      <div class="subtitle">${v.refe} – Prodotti: ${v.prod}</div>
      <div class="meta">Esito: ${v.esito}${v.follow?(' • FU: '+v.follow):''}${v.next?(' • '+v.next):''}</div>
      <div class="meta">${(v.tags||[]).map(t=>`<span class='chip'>${t}</span>`).join(' ')}</div>
      <div class="meta">${v.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="openVisitaSheet('${v.id}')">Modifica</button><button class="btn" onclick="openVisitaSheet('${v.id}',true)">Duplica</button><button class="btn" onclick="delVisita('${v.id}')">Elimina</button></div>`;
    cards.appendChild(div);
  });
  $('info_visite').textContent = `${arr.length} visite`;
}
['v_q_from','v_q_to','v_q_tipo','v_q_esito','v_q_prod','v_q_tag'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', debounce(renderVisite, 200));});
$('v_btn_sort').addEventListener('click', ()=>{ vSortRecent=!vSortRecent; $('v_btn_sort').textContent = vSortRecent?'Ordina recenti':'Ordina vecchie'; renderVisite();});
function delVisita(id){ visite=visite.filter(v=>v.id!==id); persistAll(); renderVisite(); renderDashboard(); renderFollowup(); toast('Visita eliminata'); }

/*** APPUNTAMENTI ***/
let editApptId=null;
function openApptSheet(tipo=null, refId=null){
  editApptId=null; $('sheet_appt_title').textContent='Nuovo appuntamento';
  $('a_data').value = todayISO(); $('a_ora').value=''; $('a_tipo').value=tipo||'Medico'; refreshApptRefs(); if(refId){ $('a_ref').value=refId; } $('a_tit').value=''; $('a_note').value='';
  $('sheet_appt').classList.add('open');
}
function refreshApptRefs(){const sel=$('a_ref'); if(!sel) return; sel.innerHTML=''; const tipo=$('a_tipo').value; const list=(tipo==='Medico'?medici:(tipo==='Farmacia'?farmacie:[]));
  if(list.length===0){ const opt=document.createElement('option'); opt.value=''; opt.textContent='—'; sel.appendChild(opt); } else { list.forEach(x=>{const opt=document.createElement('option'); opt.value=x.id; opt.textContent=(tipo==='Medico'?`${x.titolo||''} ${x.nome||''} ${x.cognome||''}`.trim():(x.ragione||x.id)); sel.appendChild(opt);}); }
}
$('a_tipo').addEventListener('change', refreshApptRefs);
$('btn_new_appt').addEventListener('click', ()=>openApptSheet());
$('btn_save_appt').addEventListener('click', ()=>{
  if(!$('a_data').value || !$('a_tit').value.trim()){ alert('Compila data e titolo.'); return; }
  const a={id:editApptId||uid(), data:$('a_data').value, ora:$('a_ora').value||'', tipo:$('a_tipo').value, ref:$('a_ref').value||'', tit:$('a_tit').value.trim(), note:$('a_note').value.trim()};
  if(editApptId){ const i=appuntamenti.findIndex(o=>o.id===editApptId); appuntamenti[i]=a; } else { appuntamenti.unshift(a); }
  persistAll(); closeSheets(); renderAgenda(); renderDashboard(); toast('Appuntamento salvato');
});
function renderAgenda(){
  const from=$('a_from')?.value||'', to=$('a_to')?.value||'';
  let arr=appuntamenti.filter(a=>(!from || a.data>=from) && (!to || a.data<=to)).sort((a,b)=> (a.data+a.ora).localeCompare(b.data+b.ora));
  const tb=$('tbl_agenda').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_agenda'); cards.innerHTML='';
  arr.forEach(a=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.data}</td><td>${a.ora||''}</td><td>${a.tipo}</td><td>${a.tit}</td><td>${refNameBy(a.tipo,a.ref)}</td><td>${contactInfoBy(a.tipo,a.ref)||''}</td><td>${a.note||''}</td>
      <td><button class="btn" onclick="apptToVisit('${a.id}')">→ Visita</button> <button class="btn" onclick="delAppt('${a.id}')">Elimina</button></td>`; tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main"><div class="title">${a.data}${a.ora?(' '+a.ora):''} • ${a.tit}<span class="chip">${a.tipo}</span></div><div class="meta">${refNameBy(a.tipo,a.ref)}</div><div class="meta">${a.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="apptToVisit('${a.id}')">→ Visita</button><button class="btn" onclick="delAppt('${a.id}')">Elimina</button></div>`; cards.appendChild(div);
  });
  $('info_agenda').textContent = `${arr.length} appuntamenti`;
}
function apptToVisit(id){
  const a=appuntamenti.find(x=>x.id===id); if(!a) return;
  openVisitaSheet(null); $('v_data').value=a.data; $('v_tipo').value=a.tipo==='Altro'?'Medico':a.tipo; refreshVisitRefs(); $('v_ref').value=a.ref||''; $('v_obj').value=a.tit; $('v_note').value=a.note;
}
function delAppt(id){ appuntamenti=appuntamenti.filter(a=>a.id!==id); persistAll(); renderAgenda(); renderDashboard(); toast('Appuntamento eliminato'); }

/*** FOLLOW-UP ***/
function renderFollowup(){
  const mode=$('fu_state').value, t=todayISO(), s=addDays(t,3);
  let data=visite.filter(v=>v.follow); if(mode==='over') data=data.filter(v=>v.follow<t); if(mode==='soon') data=data.filter(v=>v.follow>=t&&v.follow<=s); if(mode==='future') data=data.filter(v=>v.follow>s);
  data.sort((a,b)=>a.follow.localeCompare(b.follow));
  const tb=$('tbl_follow').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_follow'); cards.innerHTML='';
  data.forEach(v=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${v.follow}</td><td>${v.tipo}</td><td>${refNameBy(v.tipo,v.ref)}</td><td>${v.next||''}</td><td>${contactInfoBy(v.tipo,v.ref)||''}</td><td>${v.note||''}</td>
      <td><button class="btn" onclick="completeFU('${v.id}')">✓ Fatto</button> <button class="btn" onclick="postponeFU('${v.id}',1)">+1g</button> <button class="btn" onclick="postponeFU('${v.id}',3)">+3g</button> <button class="btn" onclick="postponeFU('${v.id}',7)">+7g</button></td>`; tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main">
      <div class="title">${v.follow} • ${v.tipo}<span class="chip">${refNameBy(v.tipo,v.ref)}</span></div>
      <div class="meta">${v.next||''}</div><div class="meta">${contactInfoBy(v.tipo,v.ref)||''}</div><div class="meta">${v.note||''}</div></div>
      <div class="actions"><button class="btn" onclick="completeFU('${v.id}')">✓ Fatto</button><button class="btn" onclick="postponeFU('${v.id}',1)">+1g</button><button class="btn" onclick="postponeFU('${v.id}',3)">+3g</button><button class="btn" onclick="postponeFU('${v.id}',7)">+7g</button></div>`;
    cards.appendChild(div);
  });
}
function completeFU(id){ const v=visite.find(x=>x.id===id); if(!v) return; v.follow=''; v.next=''; persistAll(); renderFollowup(); renderDashboard(); toast('Follow-up completato'); }
function postponeFU(id,days){ const v=visite.find(x=>x.id===id); if(!v || !v.follow) return; v.follow = addDays(v.follow,days); persistAll(); renderFollowup(); toast('Follow-up posticipato'); }

/*** REPORT ***/
function renderReport(){
  const m=$('r_month').value || todayISO().slice(0,7); $('r_month').value=m;
  const tag=($('r_tag').value||'').toLowerCase(); const refe=$('r_refe').value||'';
  const arr=visite.filter(v=>v.data.slice(0,7)===m && (!refe || v.refe===refe) && (!tag || (v.tags||[]).join(',').toLowerCase().includes(tag)));
  $('rk_visite').textContent=arr.length;
  $('rk_nuovi').textContent=arr.filter(v=>v.esito==='Nuovo contatto').length;
  $('rk_fu').textContent=arr.filter(v=>v.follow).length;
  $('rk_fv').textContent=arr.reduce((a,v)=>a+(+v.fv||0),0);
  $('rk_fl').textContent=arr.reduce((a,v)=>a+(+v.fl||0),0);
  const tb=$('tbl_rep').querySelector('tbody'); tb.innerHTML=''; const cards=$('cards_rep'); cards.innerHTML='';
  arr.sort((a,b)=>a.data.localeCompare(b.data)).forEach(v=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${v.data}</td><td>${v.tipo}</td><td>${refNameBy(v.tipo,v.ref)}</td><td>${v.prod}</td><td>${v.esito}</td><td>${(v.tags||[]).join(' · ')}</td><td>${v.refe}</td><td>${v.follow||''}</td><td>${v.fv||0}/${v.fl||0}</td>`; tb.appendChild(tr);
    const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="main"><div class="title">${v.data} • ${v.tipo}<span class="chip">${refNameBy(v.tipo,v.ref)}</span></div>
      <div class="meta">Esito: ${v.esito} • Tag: ${(v.tags||[]).join(', ')}</div>
      <div class="meta">${v.refe} • FU: ${v.follow||'—'} • Ord: ${v.fv||0}/${v.fl||0}</div></div>`; cards.appendChild(div);
  });
}
$('r_month').addEventListener('input', renderReport);
$('r_tag').addEventListener('input', debounce(renderReport, 200));
$('r_refe').addEventListener('change', renderReport);
$('btn_exp_rep').addEventListener('click', ()=>{
  const m=$('r_month').value || todayISO().slice(0,7);
  const arr=visite.filter(v=>v.data.slice(0,7)===m);
  const header='Data,Tipo,Ref,Prodotti,Esito,Tag,Referente,FollowUp,OrdFV,OrdFL\n';
  const rows=arr.map(v=>[v.data,v.tipo,refNameBy(v.tipo,v.ref),v.prod,v.esito,(v.tags||[]).join('|'),v.refe,v.follow||'',v.fv||0,v.fl||0].map(x=>JSON.stringify(x)).join(',')).join('\n');
  dl('report_'+m+'.csv', header+rows);
});

/*** BACKUP/RESET ***/
$('btn_exp_json').addEventListener('click', ()=>{
  const payload = { exportedAt: new Date().toISOString(), version: 'v1.0', account: ACCOUNT?.email||null, profile: PROFILE, medici, farmacie, visite, appuntamenti };
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'})); a.download='biotos_crm_backup_'+(ACCOUNT?.email||'anon')+'_'+(PROFILE||'default')+'.json'; a.click();
});
$('inp_imp_json').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const rd = new FileReader(); rd.onload = () => {
    try{
      const obj = JSON.parse(rd.result); medici = obj.medici||[]; farmacie = obj.farmacie||[]; visite = obj.visite||[]; appuntamenti = obj.appuntamenti||[];
      persistAll(); renderAll(); alert('Backup importato con successo');
    }catch(err){ alert('File non valido'); }
  }; rd.readAsText(f);
});
$('btn_clear').addEventListener('click', ()=>{ if(!confirm('Cancellare tutti i dati (profilo corrente)?')) return; medici=[]; farmacie=[]; visite=[]; appuntamenti=[]; persistAll(); renderAll(); toast('Dati azzerati'); });

/*** ACCOUNT UI ***/
$('btn_show_reg').addEventListener('click',()=>{ $('sheet_auth').classList.remove('open'); $('sheet_reg').classList.add('open'); });
$('btn_login').addEventListener('click', async ()=>{
  try{ await login(($('auth_email').value||'').trim(), $('auth_pw').value||''); $('sheet_auth').classList.remove('open'); ensureProfile(); appInitLoad(); renderAccount(); }
  catch(e){ alert(e.message); }
});
$('btn_reg').addEventListener('click', async ()=>{
  try{
    const name=($('reg_name').value||'').trim(), email=($('reg_email').value||'').trim(), pw=$('reg_pw').value||'';
    if(!name||!email||!pw) throw new Error('Compila tutti i campi');
    const accts = await acctAll();
    const role = accts.length? 'user' : 'master';
    const a = await createAccount({name,email,password:pw,role});
    ACCOUNT=a; localStorage.setItem('accountId', a.id);
    $('sheet_reg').classList.remove('open'); $('accountBadge').textContent = a.name + ' • ' + a.role;
    ensureProfile(); appInitLoad(); renderAccount();
  }catch(e){ alert(e.message); }
});
$('btn_logout').addEventListener('click', ()=>{ logout(); });
$('btn_acc_save').addEventListener('click', async ()=>{
  if(!ACCOUNT) return;
  ACCOUNT.name = $('acc_name').value.trim();
  ACCOUNT.email = $('acc_email').value.trim();
  await acctPut(ACCOUNT); $('accountBadge').textContent = ACCOUNT.name + ' • ' + ACCOUNT.role + (PROFILE?(' • profilo: '+PROFILE):''); toast('Profilo aggiornato');
});
$('btn_pw').addEventListener('click', ()=>{ $('sheet_pw').classList.add('open'); });
$('btn_pw_save').addEventListener('click', async ()=>{
  if(!ACCOUNT) return;
  const old = $('pw_old').value||'', nw=$('pw_new').value||'';
  if(!old||!nw) return alert('Compila entrambi i campi');
  const ok = (await cryptoHash(old, ACCOUNT.pw.salt))===ACCOUNT.pw.hash;
  if(!ok) return alert('Password attuale errata');
  const salt = Math.random().toString(36).slice(2) + Date.now().toString(36).slice(-4);
  const hash = await cryptoHash(nw, salt);
  ACCOUNT.pw = {salt,hash}; await acctPut(ACCOUNT); $('sheet_pw').classList.remove('open'); toast('Password aggiornata');
});
async function renderAccount(){
  if(!ACCOUNT){ $('team_pan').style.display='none'; return; }
  $('acc_name').value = ACCOUNT.name||'';
  $('acc_email').value = ACCOUNT.email||'';
  $('acc_role').value = ACCOUNT.role||'';
  const isMaster = ACCOUNT.role==='master';
  $('team_pan').style.display = isMaster? 'block':'none';
  if(isMaster){
    const all = (await acctAll()).filter(a=>a.parentId===ACCOUNT.id || a.id===ACCOUNT.id);
    const tb=$('tbl_users').querySelector('tbody'); tb.innerHTML='';
    all.forEach(a=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.name}</td><td>${a.email}</td><td>${a.role}</td><td>
      ${a.id!==ACCOUNT.id?`<button class="btn" onclick="impersonate('${a.id}')">Impersona</button> <button class="btn" onclick="resetPw('${a.id}')">Reset PW</button> <button class="btn" onclick="removeUser('${a.id}')">Elimina</button>`:'<span class="muted">—</span>'}</td>`;
      tb.appendChild(tr);
    });
  }
}
$('btn_add_user').addEventListener('click', async ()=>{
  try{
    if(!ACCOUNT || ACCOUNT.role!=='master') return;
    const name=($('u_name').value||'').trim(), email=($('u_email').value||'').trim(), pw=$('u_pw').value||'';
    if(!name||!email||!pw) throw new Error('Compila tutti i campi');
    await createAccount({name,email,password:pw,role:'user',parentId:ACCOUNT.id});
    $('u_name').value='';$('u_email').value='';$('u_pw').value='';
    toast('Utente creato'); renderAccount();
  }catch(e){ alert(e.message); }
});
async function impersonate(id){
  const a = await acctGet(id); if(!a) return;
  ACCOUNT=a; localStorage.setItem('accountId', a.id);
  $('accountBadge').textContent = a.name + ' • ' + a.role; PROFILE=''; localStorage.removeItem(accK()+'profile');
  ensureProfile(); appInitLoad(); renderAccount(); toast('Impersonazione attiva');
}
async function resetPw(id){
  const a = await acctGet(id); if(!a) return;
  const nw = prompt('Nuova password per '+a.email+':'); if(!nw) return;
  const salt = Math.random().toString(36).slice(2) + Date.now().toString(36).slice(-4);
  const hash = await cryptoHash(nw, salt); a.pw={salt,hash}; await acctPut(a); toast('Password resettata');
}
async function removeUser(id){
  if(!confirm('Eliminare utente?')) return;
  await acctRemove(id); toast('Utente eliminato'); renderAccount();
}

/*** SHEETS & MISC ***/
function closeSheets(){ document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('open')); }
document.querySelectorAll('.sheet .close').forEach(b=>b.addEventListener('click',()=>{ closeSheets(); }));
window.addEventListener('keydown',e=>{ if(e.key==='Escape') closeSheets(); });

/*** IO tab helpers ***/
$('btn_save_cfg').addEventListener('click', ()=>{
  const cfg = {accent:$('cfg_accent').value, req:$('cfg_req').value, fu:parseInt($('cfg_fu').value||'7',10)||7};
  localStorage.setItem(accK()+'cfg', JSON.stringify(cfg)); applyTheme(localStorage.getItem('theme')||'auto'); persistAll(); toast('Impostazioni salvate');
});

function renderAll(){ renderMedici(); renderFarmacie(); refreshVisitRefs(); renderVisite(); renderAgenda(); renderDashboard(); renderFollowup(); renderReport(); renderAccount(); }
function updateStorageUsage(){try{const sz=(JSON.stringify({medici,farmacie,visite,appuntamenti}).length||0); $('stor_usage').textContent=(sz/1024).toFixed(1)+' KB';}catch(_){ $('stor_usage').textContent='—'; }}

/*** STARTUP ***/
(async function start(){
  // Service worker (PWA)
  if('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('./sw.js'); }catch(e){} }
  // Theme accent da cfg
  const cfg = JSON.parse(localStorage.getItem(accK()+'cfg')||'{}');
  if(cfg.accent) document.documentElement.style.setProperty('--accent', cfg.accent);
  // auth -> profile -> data
  const ok = await (async function ensureAuth(){
    const id = localStorage.getItem('accountId');
    const accts = await acctAll();
    if(!accts.length){ $('sheet_reg').classList.add('open'); return false; }
    if(!id){ $('sheet_auth').classList.add('open'); return false; }
    const a = await acctGet(id);
    if(!a){ $('sheet_auth').classList.add('open'); return false; }
    ACCOUNT=a; $('accountBadge').textContent = a.name + ' • ' + a.role;
    return true;
  })();
  if(ok){ ensureProfile(); appInitLoad(); }
})();

/*** EXPORT MED/FARM/ICS ***/
function listToCSV(rows, header){ return header + rows.map(r=>r.map(x=>JSON.stringify(x??'')).join(',')).join('\n'); }
$('btn_exp_med')?.addEventListener('click', ()=>{
  const header='Titolo,Nome,Cognome,Spec,Struttura,Comune,Indirizzo,Telefono,Email,Tag,Note\n';
  const rows=medici.map(m=>[m.titolo,m.nome,m.cognome,m.spec,m.struttura,m.comune,m.indirizzo,m.telefono,m.email,(m.tags||[]).join('|'),m.note||'']);
  dl('medici.csv', listToCSV(rows, header));
});
$('btn_imp_med')?.addEventListener('change',()=>{});
$('btn_exp_far')?.addEventListener('click', ()=>{
  const header='Ragione,Direttore,Comune,Indirizzo,Telefono,Email,Tag,Note\n';
  const rows=farmacie.map(f=>[f.ragione,f.direttore,f.comune,f.indirizzo,f.telefono,f.email,(f.tags||[]).join('|'),f.note||'']);
  dl('farmacie.csv', listToCSV(rows, header));
});
$('btn_imp_far')?.addEventListener('change',()=>{});
$('btn_exp_vis')?.addEventListener('click', ()=>{
  const header='Data,Tipo,Ref,Prodotti,Esito,Next,FU,Tag,Ref.,OrdFV,OrdFL,Note\n';
  const rows=visite.map(v=>[v.data,v.tipo,refNameBy(v.tipo,v.ref),v.prod,v.esito,v.next||'',v.follow||'',(v.tags||[]).join('|'),v.refe,v.fv||0,v.fl||0,v.note||'']);
  dl('visite.csv', listToCSV(rows, header));
});
$('btn_exp_ics')?.addEventListener('click', ()=>{
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Biotos CRM//IT'];
  visite.filter(v=>v.follow).forEach(v=>{
    const dt=v.follow.replace(/-/g,''); const sum=`FU ${refNameBy(v.tipo,v.ref)} – ${v.next||'Follow-up'}`;
    lines.push('BEGIN:VEVENT','UID:'+uid()+'@biotos','DTSTAMP:'+dt+'T090000Z','DTSTART;VALUE=DATE:'+dt,'SUMMARY:'+sum,'END:VEVENT');
  });
  lines.push('END:VCALENDAR'); dl('followup.ics', lines.join('\r\n'));
});
</script>
</body>
</html>
